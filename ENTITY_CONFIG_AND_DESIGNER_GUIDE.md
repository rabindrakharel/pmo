# Entity Configuration, Entity Designer & Settings Architecture
## Complete Codebase Search Results

---

## SECTION 1: ENTITY COLUMN CONFIGURATION

### Current Implementation
**File:** `/home/rabin/projects/pmo/apps/web/src/lib/entityConfig.ts`
- **Lines:** 27,822 tokens (too large to display entire file)
- **Key sections:**
  - Entity configuration types (EntityConfig, ColumnDef, FieldDef)
  - Entity configurations for 18+ entity types (project, task, employee, etc.)
  - Field definitions with form metadata
  - Support for dynamic options loading from settings

### Architecture Pattern
```typescript
// entityConfig.ts structure (lines 259-301)
export interface EntityConfig {
  name: string;                      // e.g., 'project'
  displayName: string;               // e.g., 'Project'
  pluralName: string;                // e.g., 'Projects'
  apiEndpoint: string;               // e.g., '/api/v1/project'
  
  columns: ColumnDef[];             // Auto-generated (v4.0)
  fields: FieldDef[];               // Form field definitions
  supportedViews: ViewMode[];       // 'table', 'kanban', 'grid', etc.
  defaultView: ViewMode;            // Default view mode
  
  // Optional configurations
  shareable?: boolean;
  hierarchical?: {...};
  kanban?: {...};
  grid?: {...};
}

export interface ColumnDef {
  key: string;
  title: string;
  sortable?: boolean;
  filterable?: boolean;
  align?: 'left' | 'center' | 'right';
  width?: string;
  visible?: boolean;               // false for IDs and foreign keys
  render?: (value: any, record: any) => React.ReactNode;
  loadOptionsFromSettings?: boolean;
  options?: SettingOption[];
  inlineEditable?: boolean;
}

export interface FieldDef {
  key: string;
  label: string;
  type: 'text' | 'textarea' | 'richtext' | 'number' | 'date' | 'select' | 'multiselect' | 'jsonb' | 'array';
  required?: boolean;
  readonly?: boolean;
  disabled?: boolean;
  loadOptionsFromSettings?: boolean;
  loadOptionsFromEntity?: string;
}
```

### Column Auto-Generation (v4.0)
**Key Features:**
- Columns are marked as empty arrays: `columns: []` (auto-generated)
- Auto-detection via `universalFieldDetector.ts` + `viewConfigGenerator.ts`
- Columns auto-generated by EntityDataTable's `renderCellValue()` function
- Foreign key intelligent handling: `project_id` → hides ID, auto-generates `project_name`

### Example Configuration (lines 407-432)
```typescript
project: {
  name: 'project',
  displayName: 'Project',
  pluralName: 'Projects',
  apiEndpoint: '/api/v1/project',
  
  columns: [], // Auto-generated (v4.0)
  
  fields: [
    { key: 'name', label: 'Project Name', type: 'text', required: true },
    { key: 'code', label: 'Project Code', type: 'text', required: true },
    { key: 'descr', label: 'Description', type: 'richtext' },
    { key: 'dl__project_stage', label: 'Stage', type: 'select', loadOptionsFromSettings: true },
    { key: 'budget_allocated_amt', label: 'Budget', type: 'number' },
    { key: 'planned_start_date', label: 'Start Date', type: 'date' },
    { key: 'planned_end_date', label: 'End Date', type: 'date' },
    { key: 'metadata', label: 'Metadata', type: 'jsonb' }
  ],
  
  supportedViews: ['table'],
  defaultView: 'table'
},
```

---

## SECTION 2: BACKEND SCHEMA METADATA SYSTEM

### Universal Schema Metadata
**File:** `/home/rabin/projects/pmo/apps/api/src/lib/universal-schema-metadata.ts`
- **Purpose:** Automatic column classification based on naming conventions
- **Size:** 828 lines
- **Approach:** Pattern-based metadata without table-specific configs

### ColumnMetadata Interface
```typescript
export interface ColumnMetadata {
  // API Restrictions
  'api:restrict'?: boolean;
  'api:pii_masking'?: boolean;
  'api:financial_masking'?: boolean;
  'api:auth_field'?: boolean;
  'api:safety_info'?: boolean;
  'api:system_field'?: boolean;
  
  // UI Visibility & Behavior
  'ui:invisible'?: boolean;
  'ui:search'?: boolean;
  'ui:sort'?: boolean;
  'ui:readonly'?: boolean;
  
  // UI Field Types (15+ types)
  'ui:color_field'?: boolean;
  'ui:geographic'?: boolean;
  'ui:timezone'?: boolean;
  'ui:currency'?: boolean;
  'ui:hierarchy'?: boolean;
  'ui:multiselect'?: boolean;
  'ui:textarea'?: boolean;
  'ui:date'?: boolean;
  'ui:datetime'?: boolean;
  // ... and 6 more types
  
  // Special Behaviors
  'flexible'?: boolean;
  'audit'?: boolean;
  'hierarchy'?: boolean;
  'permission'?: boolean;
  'financial'?: boolean;
  'contact'?: boolean;
  'location'?: boolean;
  'identity'?: boolean;
  'temporal'?: boolean;
  'classification'?: boolean;
  'workflow'?: boolean;
  'performance'?: boolean;
}
```

### Pattern-Based Classification (Lines 79-530)
**Two-level system:**
1. **Exact matches** (UNIVERSAL_COLUMN_PATTERNS): Specific columns like 'name', 'email', 'phone'
2. **Pattern rules** (PATTERN_RULES): Regex patterns for common naming conventions

**Example Patterns:**
```typescript
// ID patterns
{ pattern: /_id$/, metadata: { 'ui:invisible': true } }

// Date/time patterns  
{ pattern: /_date$/, metadata: { 'temporal': true, 'ui:date': true } }
{ pattern: /_ts$/, metadata: { 'temporal': true, 'ui:datetime': true } }

// Status patterns
{ pattern: /_status$/, metadata: { 'workflow': true, 'ui:status': true, 'ui:badge': true } }

// Boolean flag patterns
{ pattern: /^is_/, metadata: { 'ui:toggle': true } }
{ pattern: /^has_/, metadata: { 'ui:toggle': true } }

// Financial patterns
{ pattern: /(budget|salary|amount|amt|cost|price|fee)/, metadata: { 'financial': true, 'api:financial_masking': true } }

// Contact patterns
{ pattern: /(phone|mobile|email|contact)/, metadata: { 'contact': true, 'api:pii_masking': true } }
```

### Key Functions
- `getUniversalColumnMetadata(columnName)` - Get metadata for a single column
- `getColumnsByMetadata(columns, metadataKey)` - Filter by metadata property
- `filterUniversalColumns(data, permissions)` - Filter object columns based on metadata
- `getUniversalComponentProps(columnName)` - Get React component props for a column

### Legacy Schema Metadata (Deprecated)
**File:** `/home/rabin/projects/pmo/apps/api/src/lib/schema-metadata.ts`
- **Size:** 523 lines
- **Status:** Still present but being phased out in favor of universal-schema-metadata.ts
- **Approach:** Table-specific metadata map

---

## SECTION 3: ENTITY DESIGNER / BUILDER COMPONENTS

### Main Designer Page
**File:** `/home/rabin/projects/pmo/apps/web/src/pages/setting/EntityDesignerPage.tsx`
- **Purpose:** UI for creating and editing entity types
- **Status:** Fully implemented and functional
- **Key features:**
  - Entity metadata editing (code, name, ui_label, icon, display_order)
  - Column definition editor
  - Parent-child relationship management
  - DDL preview generation

### EntityDesignerData Interface (Lines 20-30)
```typescript
interface EntityDesignerData {
  entity_code: string;           // e.g., 'project'
  entity_name: string;           // e.g., 'Project'
  entity_ui_label: string;       // e.g., 'Projects'
  entity_type: 'attribute' | 'transactional';
  columns: ColumnDefinition[];   // Custom columns
  parent_entities: string[];     // Incoming relationships
  child_entities: string[];      // Outgoing relationships
  ui_icon: string;              // Lucide icon name
  display_order: number;        // Sidebar order
}

interface ColumnDefinition {
  id: string;
  column_name: string;
  data_type: 'text' | 'number' | 'date' | 'boolean' | 'json';
  description: string;
  required: boolean;
  order: number;
}
```

### Entity Builder Sub-Components
**Directory:** `/home/rabin/projects/pmo/apps/web/src/components/entity-builder/`

**Files:**
1. **ColumnEditor.tsx** (12,282 bytes)
   - Edit/add/reorder custom columns
   - Standard columns automatically included (id, code, name, created_ts, etc.)
   - Supports 5 data types: text, number, date, boolean, json
   - Handles transactional entity linkage columns

2. **EntityTypeSelector.tsx** (4,751 bytes)
   - Toggle between 'attribute' and 'transactional' entity types
   - Attribute: Standalone data (like product, service)
   - Transactional: Always linked to parent (like task, order)

3. **EntityLinkageEditor.tsx** (8,632 bytes)
   - Define parent-child relationships
   - Specify which entities can be parents/children

4. **IconDisplaySettings.tsx** (7,604 bytes)
   - Pick Lucide icon for entity
   - Set display order in sidebar/menu

5. **DDLPreviewModal.tsx** (3,663 bytes)
   - Generate and preview DDL statements
   - Shows SQL table creation syntax

### Designer Page Workflow (Lines 32-143)
```typescript
// 1. Fetch existing entity metadata (if editing)
useEffect(() => {
  const response = await fetch(`/api/v1/entity/type/${entityCode}`);
  const data = await response.json();
  setEntityData(prev => ({...prev, ...data}));
}, [entityCode]);

// 2. Handle various state changes
handleEntityTypeChange(type)           // attribute vs transactional
handleColumnsChange(columns)           // Custom columns
handleParentEntitiesChange(parents)    // Incoming relationships
handleChildEntitiesChange(children)    // Outgoing relationships
handleIconChange(icon)                 // Lucide icon
handleDisplayOrderChange(order)        // Sidebar order

// 3. Generate and preview DDL
const handlePreviewDDL = async () => {
  const response = await fetch(`/api/v1/entity-builder/preview`, {
    method: 'POST',
    body: JSON.stringify(entityData)
  });
  const result = await response.json();
  setGeneratedDDL(result.ddl);
};

// 4. Create entity
const handleCreateEntity = async () => { ... }
```

---

## SECTION 4: ENTITY METADATA TABLE (d_entity)

### Database Table Definition
**File:** `/home/rabin/projects/pmo/db/XLV_d_entity.ddl`
- **Size:** 510 lines
- **Purpose:** Single source of truth for entity TYPE definitions (not instances)
- **Created:** Fully seeded with 25+ entity types

### Table Structure
```sql
CREATE TABLE app.d_entity (
    code varchar(50) NOT NULL PRIMARY KEY,     -- 'project', 'task', 'office'
    name varchar(100) NOT NULL,                -- 'Project', 'Task', 'Office'
    ui_label varchar(100) NOT NULL,            -- 'Projects', 'Tasks', 'Offices'
    ui_icon varchar(50),                       -- Lucide icon: 'FolderOpen', 'CheckSquare'
    child_entities jsonb DEFAULT '[]'::jsonb,  -- Child metadata array
    display_order int4 NOT NULL DEFAULT 999,   -- Sidebar/menu display order
    active_flag boolean DEFAULT true,
    created_ts timestamptz DEFAULT now(),
    updated_ts timestamptz DEFAULT now()
);
```

### Child Entities JSONB Structure
```json
[
  {
    "entity": "task",
    "ui_icon": "CheckSquare",
    "ui_label": "Tasks",
    "order": 1
  },
  {
    "entity": "wiki",
    "ui_icon": "BookOpen",
    "ui_label": "Wiki",
    "order": 2
  }
]
```

### Parent-Child Relationships (Lines 24-32)
**Defined in DDL seeded data:**
- office → task, artifact, wiki, form, cost, revenue
- business → project, cost, revenue
- project → task, wiki, artifact, form, cost, revenue
- task → form, artifact, cost, revenue, employee
- cust → project, artifact, form, cost, revenue
- role → employee
- form, quote, order → (variable children)
- event → task, project, service, cust, employee, business

### Seeded Entity Types (Lines 61-510)
1. office (6 children)
2. business (3 children)
3. project (6 children)
4. task (4 children)
5. cust/customer (5 children)
6. role (1 child)
7. form (1 child)
8. employee (leaf)
9. wiki (leaf)
10. artifact (leaf)
11. worksite (leaf)
12. reports (leaf)
13. calendar (leaf)
14. service (leaf)
15. product (leaf)
16. quote (1 child)
17. work_order (leaf)
18. inventory (leaf)
19. order (2 children)
20. invoice (leaf)
21. shipment (leaf)
22. cost (leaf)
23. revenue (leaf)
24. workflow (leaf)
25. event (6 children)
26. office_hierarchy (leaf)
27. business_hierarchy (leaf)
28. product_hierarchy (leaf)
29. message_schema (leaf)
30. message (leaf)
31. interaction (leaf)
32. workflow_automation (leaf)

---

## SECTION 5: SETTINGS / DATALABEL SYSTEM

### Unified Settings Table
**File:** `/home/rabin/projects/pmo/db/II_setting_datalabel.ddl`
- **Purpose:** Centralized table for ALL entity data labels (stages, statuses, priorities)
- **Size:** Partially shown (continued on next page)
- **Replaces:** 17 separate tables with one JSONB-based structure

### Table Structure
```sql
CREATE TABLE app.setting_datalabel (
    datalabel_name VARCHAR(100) PRIMARY KEY,
    ui_label VARCHAR(100) NOT NULL,
    ui_icon VARCHAR(50),
    metadata JSONB NOT NULL,
    updated_ts TIMESTAMPTZ DEFAULT now()
);
```

### Datalabel Naming Convention
```
dl__{entity}_{label_type}

Examples:
- dl__task_stage         (Task workflow stages)
- dl__project_stage      (Project workflow stages)
- dl__task_priority      (Task priority levels)
- dl__form_submission_status
- dl__form_approval_status
- dl__wiki_publication_status
- dl__customer_tier
- dl__customer_opportunity_funnel
- dl__quote_stage
- dl__work_order_status
```

### Metadata JSONB Structure (Lines 53-76)
```json
{
  "id": 0,
  "name": "Backlog",
  "descr": "Tasks in backlog, not yet started",
  "parent_ids": [],
  "entity_name": "task",
  "terminal_flag": false,
  "color_code": "gray"
}
```

### Seeded Datalabels (Sample)
**Task Labels:**
- dl__task_stage: 7 stages (Backlog → Planning → To Do → In Progress → In Review → Completed/Blocked)
- dl__task_priority: 4 levels (low, medium, high, critical)
- dl__task_update_type: 4 types (Status Change, Comment, Assignment, Due Date)

**Project Labels:**
- dl__project_stage: Sequential stages (Initiation → Planning → Execution → Closure)

---

## SECTION 6: SETTINGS PAGES

### Settings Overview Page
**File:** `/home/rabin/projects/pmo/apps/web/src/pages/setting/SettingsOverviewPage.tsx`
- **Size:** 100+ lines (partial read shown)
- **Status:** Fully implemented
- **Features:**
  - Datalabel management (add, edit, delete)
  - Entity management with child entity editor
  - Icon picker for settings
  - Search and filtering

### SettingsPage
**File:** `/home/rabin/projects/pmo/apps/web/src/pages/setting/SettingsPage.tsx`
- **Size:** 40 lines
- **Purpose:** Main settings entry point
- **Features:**
  - Entity linkage system information
  - Link to UnifiedLinkageModal component

### SettingDetailPage
**File:** `/home/rabin/projects/pmo/apps/web/src/pages/setting/SettingDetailPage.tsx`
- **Purpose:** Edit individual setting/datalabel

### Settings Context
**Key State Management:**
- `useSettings()` hook for settings context
- `exitSettingsMode()` function for navigation

---

## SECTION 7: API ROUTES FOR ENTITY METADATA

### Entity Routes
**File:** `/home/rabin/projects/pmo/apps/api/src/modules/entity/routes.ts`
- **Purpose:** Serve entity TYPE metadata (not instances)
- **Authentication:** All routes require JWT authentication

### API Endpoints
1. **GET /api/v1/entity/type/:entity_type**
   - Returns metadata for a specific entity type
   - Schema: EntityTypeMetadataSchema
   - Returns: code, name, ui_label, ui_icon, child_entities, display_order, active_flag
   - Example: `/api/v1/entity/type/project` → Project metadata with task/wiki/artifact/form children

2. **GET /api/v1/entity/types**
   - Returns all entity types ordered by display_order
   - Used for sidebar/navigation menu generation

3. **Child Entity Count Endpoints**
   - ChildEntityCountSchema for querying entity instance counts

### Entity Alias Mapping (Lines 25-29)
```typescript
const ENTITY_ALIAS_MAP: Record<string, string> = {
  'biz': 'business',
  'client': 'cust',  // Map 'client' to 'cust' (customer)
  // Add more aliases as needed
};

function normalizeEntityType(entityType: string): string {
  return ENTITY_ALIAS_MAP[entityType] || entityType;
}
```

---

## SECTION 8: BACKEND SCHEMA GENERATION

### Entity Schema Generator
**File:** `/home/rabin/projects/pmo/apps/api/src/lib/entitySchemaGenerator.ts`
- **Size:** Partial read (80 lines shown)
- **Purpose:** Generate TypeBox schemas from EntityConfig
- **Provides type-safe API validation and documentation

### Schema Generation Methods
```typescript
class EntitySchemaGenerator {
  generateResponseSchema()  // API responses (includes all fields)
  generateCreateSchema()    // Create requests (excludes generated fields)
  generateUpdateSchema()    // Update requests (all optional except ID)
  generateQuerySchema()     // Query parameters (list endpoints)
}
```

---

## SECTION 9: KEY PATTERNS & RELATIONSHIPS

### Entity Configuration Flow
```
1. DATABASE LAYER
   - d_entity table stores entity TYPE metadata
   - setting_datalabel stores options/stages
   - Individual d_* tables store entity INSTANCES

2. BACKEND API
   - /api/v1/entity/type/:code → Returns d_entity row
   - /api/v1/entity/types → Returns all entity types
   - /api/v1/setting → Returns datalabel options
   - /api/v1/:entity → Returns entity instances

3. FRONTEND CONFIG
   - entityConfig.ts defines column/field structure
   - entityConfigs[entityType] has all metadata
   - columns: [] auto-generated from database
   - fields: [] used in EntityFormContainer

4. COMPONENT RENDERING
   - EntityDataTable uses entityConfig.columns
   - EntityFormContainer uses entityConfig.fields
   - DynamicChildEntityTabs uses d_entity.child_entities
   - Settings dropdowns use loadOptionsFromSettings flag
```

### Column Visibility Pattern
```typescript
// Foreign Keys
- project_id:    visible: false (hidden, used for API)
- project_name:  visible: true  (auto-generated, shows entity name)

// System Fields
- id:           visible: false
- created_ts:   visible: false
- updated_ts:   visible: false
- from_ts:      visible: false (audit)
- to_ts:        visible: false (audit)
- active_flag:  visible: false

// Data Fields
- name:         visible: true  (searchable, sortable)
- code:         visible: true  (searchable)
- descr:        visible: true  (searchable)
- dl__*:        visible: true  (loadOptionsFromSettings)
```

---

## SECTION 10: CONFIGURATION LOCATIONS SUMMARY

| Item | Location | Type | Key Points |
|------|----------|------|-----------|
| **Entity Columns** | `apps/web/src/lib/entityConfig.ts` | TypeScript | 18+ entities defined, columns auto-generated v4.0 |
| **Entity Fields** | `apps/web/src/lib/entityConfig.ts` | TypeScript | Form field definitions with type inference |
| **Schema Metadata** | `apps/api/src/lib/universal-schema-metadata.ts` | TypeScript | Pattern-based column classification, 830 lines |
| **Entity Types** | `db/XLV_d_entity.ddl` | SQL DDL | 25+ seeded entity types, parent-child JSONB |
| **Settings/Datalabels** | `db/II_setting_datalabel.ddl` | SQL DDL | 16+ datalabel categories (stages, priorities, etc.) |
| **Entity Designer UI** | `apps/web/src/pages/setting/EntityDesignerPage.tsx` | React | Create/edit entity types, columns, relationships |
| **Entity Builder Components** | `apps/web/src/components/entity-builder/` | React | 5 sub-components (ColumnEditor, Linkage, Icons, etc.) |
| **Settings Pages** | `apps/web/src/pages/setting/` | React | SettingsOverviewPage, SettingsPage, SettingDetailPage |
| **API Entity Routes** | `apps/api/src/modules/entity/routes.ts` | Fastify | Entity metadata endpoints, alias mapping |
| **Schema Generator** | `apps/api/src/lib/entitySchemaGenerator.ts` | TypeScript | TypeBox schema generation from config |

---

## SECTION 11: HOW TO EXTEND

### Adding a New Entity Type

**Step 1: Update Database (d_entity table)**
```sql
-- Add to db/XLV_d_entity.ddl
INSERT INTO app.d_entity (code, name, ui_label, ui_icon, child_entities, display_order)
VALUES (
  'newentity',
  'New Entity',
  'New Entities',
  'IconName',
  '[
    {"entity": "child1", "ui_icon": "Icon1", "ui_label": "Child1s", "order": 1},
    {"entity": "child2", "ui_icon": "Icon2", "ui_label": "Child2s", "order": 2}
  ]'::jsonb,
  300
);
```

**Step 2: Add Entity Config**
```typescript
// In apps/web/src/lib/entityConfig.ts
newentity: {
  name: 'newentity',
  displayName: 'New Entity',
  pluralName: 'New Entities',
  apiEndpoint: '/api/v1/newentity',
  
  columns: [],  // Auto-generated
  
  fields: [
    { key: 'name', label: 'Name', type: 'text', required: true },
    { key: 'code', label: 'Code', type: 'text', required: true },
    // ... more fields
  ],
  
  supportedViews: ['table'],
  defaultView: 'table'
},
```

**Step 3: Create DDL File**
```sql
-- db/XX_d_newentity.ddl
CREATE TABLE app.d_newentity (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  code varchar(50) UNIQUE NOT NULL,
  name varchar(255) NOT NULL,
  descr text,
  created_ts timestamptz DEFAULT now(),
  updated_ts timestamptz DEFAULT now(),
  active_flag boolean DEFAULT true
);
```

### Adding Settings/Datalabels
```sql
-- In db/II_setting_datalabel.ddl
INSERT INTO app.setting_datalabel (datalabel_name, ui_label, ui_icon, metadata) VALUES
('dl__newentity_stage', 'New Entity Stages', 'Target', '[
  {"id": 0, "name": "Stage 1", "descr": "First stage", "parent_ids": [], "color_code": "blue"},
  {"id": 1, "name": "Stage 2", "descr": "Second stage", "parent_ids": [0], "color_code": "green"}
]'::jsonb);
```

Then in entityConfig fields:
```typescript
{ key: 'dl__newentity_stage', label: 'Stage', type: 'select', loadOptionsFromSettings: true }
```

---

## SECTION 12: KEY TAKEAWAYS

1. **Two-Level Configuration:**
   - **Backend:** universal-schema-metadata.ts + d_entity table
   - **Frontend:** entityConfig.ts (schema definition) + data_transform_render.ts (behavior)

2. **Database-Driven UI:**
   - Entity types defined in d_entity table
   - Child relationships stored as JSONB
   - Settings options in setting_datalabel table
   - API exposes metadata dynamically

3. **Auto-Generation (v4.0):**
   - Columns are auto-generated from naming patterns
   - Foreign keys intelligently handled (ID hidden, Name shown)
   - Field types inferred from column names

4. **Settings Integration:**
   - All dropdowns use loadOptionsFromSettings flag
   - Datalabels organized with dl__entity_type pattern
   - Color codes and workflow states managed centrally

5. **Component Architecture:**
   - EntityDesignerPage: Create/edit entity types
   - ColumnEditor: Manage custom columns
   - EntityLinkageEditor: Define relationships
   - IconDisplaySettings: Lucide icon picker
   - Settings pages: Manage datalabels and entity metadata


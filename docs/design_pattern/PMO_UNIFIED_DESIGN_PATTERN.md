# PMO Unified Design Pattern

**Version**: 1.0.0
**Date**: 2025-12-04
**Status**: Production Standard
**Scope**: Complete UI/UX, State Management, Cache Lifecycle, Rendering Architecture

---

## Executive Summary

This document defines the **complete design pattern** for the PMO Enterprise Platform, covering every aspect of UI/UX interaction, state management, cache lifecycle, and component rendering. It serves as the single source of truth for understanding how data flows through the application from API to UI and back.

### Core Principles

1. **Single Source of Truth**: TanStack Query cache is the ONLY source of application state
2. **Format-at-Read**: Cache stores RAW data, formatting happens during render
3. **Metadata-Driven**: Backend YAML configs drive ALL rendering decisions
4. **Optimistic Updates**: UI updates instantly, API syncs in background
5. **Portal-Safe Interactions**: Click-outside handlers respect portal-rendered dropdowns
6. **Nullable Types**: `undefined` means loading, `null` means empty, `{}` never used as default

---

## Table of Contents

1. [Architecture Overview](#1-architecture-overview)
2. [State Management & Cache Lifecycle](#2-state-management--cache-lifecycle)
3. [Data Flow Pipeline](#3-data-flow-pipeline)
4. [UI/UX Interaction Patterns](#4-uiux-interaction-patterns)
5. [Component Rendering Architecture](#5-component-rendering-architecture)
6. [Request Flow & API Integration](#6-request-flow--api-integration)
7. [Inline Editing Patterns](#7-inline-editing-patterns)
8. [Add Row Pattern](#8-add-row-pattern)
9. [Cache Invalidation & Synchronization](#9-cache-invalidation--synchronization)
10. [Complete Interaction Flows](#10-complete-interaction-flows)

---

## 1. Architecture Overview

### The 7-Layer System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PMO ENTERPRISE PLATFORM ARCHITECTURE                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  LAYER 1: PERSISTENCE (IndexedDB + PostgreSQL)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Dexie (IndexedDB)      â”‚         â”‚ PostgreSQL 14                â”‚        â”‚
â”‚  â”‚ â€¢ Offline persistence  â”‚   â†â”€â”€â”€â†’ â”‚ â€¢ 50 tables (46 DDL files)   â”‚        â”‚
â”‚  â”‚ â€¢ Multi-tab sync       â”‚         â”‚ â€¢ Entity infrastructure      â”‚        â”‚
â”‚  â”‚ â€¢ 8 tables (v4 schema) â”‚         â”‚ â€¢ RBAC, metadata, data       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                â†‘                              â†‘                              â”‚
â”‚                â”‚                              â”‚                              â”‚
â”‚  LAYER 2: NETWORK & API (Fastify v5 REST)                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ API Server (port 4000)                                              â”‚    â”‚
â”‚  â”‚ â€¢ 45 modules (universal-crud-factory pattern)                       â”‚    â”‚
â”‚  â”‚ â€¢ Entity infrastructure service (transactional CRUD)                â”‚    â”‚
â”‚  â”‚ â€¢ Metadata generation service (35+ pattern rules)                   â”‚    â”‚
â”‚  â”‚ â€¢ RBAC permission checks                                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                â†‘                              â†‘                              â”‚
â”‚                â”‚                              â”‚                              â”‚
â”‚  LAYER 3: STATE MANAGEMENT (TanStack Query + WebSocket)                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ TanStack Query         â”‚         â”‚ WebSocket (port 4001)        â”‚        â”‚
â”‚  â”‚ â€¢ In-memory cache      â”‚   â†â”€â”€â”€â†’ â”‚ â€¢ Real-time invalidation     â”‚        â”‚
â”‚  â”‚ â€¢ Optimistic updates   â”‚         â”‚ â€¢ system_logging polling     â”‚        â”‚
â”‚  â”‚ â€¢ Auto-refetch (SWR)   â”‚         â”‚ â€¢ SUBSCRIBE/INVALIDATE       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                â†‘                                                             â”‚
â”‚                â”‚                                                             â”‚
â”‚  LAYER 4: DATA TRANSFORMATION (Format-at-Read)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ useFormattedEntityData (Reactive Formatting)                        â”‚    â”‚
â”‚  â”‚ â€¢ Subscribes to datalabel cache (badge colors)                      â”‚    â”‚
â”‚  â”‚ â€¢ Subscribes to entityInstanceNames (references)                    â”‚    â”‚
â”‚  â”‚ â€¢ Output: { raw, display, styles }                                  â”‚    â”‚
â”‚  â”‚ â€¢ Re-formats on cache updates                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                â†‘                                                             â”‚
â”‚                â”‚                                                             â”‚
â”‚  LAYER 5: COMPONENT REGISTRY (Metadata-Driven Resolution)                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ViewComponentRegistry  â”‚         â”‚ EditComponentRegistry        â”‚        â”‚
â”‚  â”‚ â€¢ renderType â†’ FC      â”‚         â”‚ â€¢ inputType â†’ FC             â”‚        â”‚
â”‚  â”‚ â€¢ DAGVisualizer        â”‚         â”‚ â€¢ BadgeDropdownSelect        â”‚        â”‚
â”‚  â”‚ â€¢ MetadataTable        â”‚         â”‚ â€¢ EntityInstanceNameSelect   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                â†‘                              â†‘                              â”‚
â”‚                â”‚                              â”‚                              â”‚
â”‚  LAYER 6: UI COMPONENTS (3 Universal Pages)                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ EntityListOfInstancesPage â†’ EntityListOfInstancesTable             â”‚    â”‚
â”‚  â”‚ EntitySpecificInstancePage â†’ EntityInstanceFormContainer           â”‚    â”‚
â”‚  â”‚ EntityCreatePage â†’ EntityInstanceFormContainer                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                â†‘                                                             â”‚
â”‚                â”‚                                                             â”‚
â”‚  LAYER 7: INTERACTION HANDLERS (Portal-Aware, Optimistic)                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ Inline edit (long-press 500ms)                                    â”‚    â”‚
â”‚  â”‚ â€¢ Cell edit (click cell)                                            â”‚    â”‚
â”‚  â”‚ â€¢ Add row (optimistic temp row)                                     â”‚    â”‚
â”‚  â”‚ â€¢ Portal dropdown selection (data-dropdown-portal)                  â”‚    â”‚
â”‚  â”‚ â€¢ Click-outside handlers (mousedown, early return)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. State Management & Cache Lifecycle

### The Single Source of Truth Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STATE MANAGEMENT ARCHITECTURE (v9.1.0)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  âŒ NEVER DO THIS (Multiple Sources of Truth):                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚  const [localData, setLocalData] = useState([]);  // âŒ Duplicate state    â”‚
â”‚  const { data } = useQuery(...);                  // âœ… Only source         â”‚
â”‚  const [cache, setCache] = useState({});          // âŒ Duplicate cache     â”‚
â”‚                                                                              â”‚
â”‚  âœ… CORRECT PATTERN (Single Source):                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  const { data } = useQuery(...);  // TanStack Query cache                  â”‚
â”‚  // UI renders directly from cache - NO local copies!                       â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                     TanStack Query Cache                             â”‚    â”‚
â”‚  â”‚                   (SINGLE SOURCE OF TRUTH)                           â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  Store Structure (v9.3.0 - Aligned with Dexie v4):                  â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  ['datalabel', datalabelKey]                    TTL: 10 min         â”‚    â”‚
â”‚  â”‚    â†’ [{ id, name, color_code, sort_order }]                         â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  ['entityCode', entityCode]                     TTL: 30 min         â”‚    â”‚
â”‚  â”‚    â†’ { code, label, icon, child_entity_codes }                      â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  ['entityInstanceData', entityCode, params]     TTL: 5 min (stale)  â”‚    â”‚
â”‚  â”‚    â†’ { data: [...], total, metadata, ref_data_entityInstance }      â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  ['entityInstanceMetadata', entityCode, comp]   TTL: 30 min         â”‚    â”‚
â”‚  â”‚    â†’ { fields: [], viewType: {...}, editType: {...} }               â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  ['entityInstance', entityCode, id]             TTL: 5 min (stale)  â”‚    â”‚
â”‚  â”‚    â†’ { id, code, name, ..., metadata }                              â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  ['entityInstanceNames', entityCode]            TTL: 10 min          â”‚    â”‚
â”‚  â”‚    â†’ { 'uuid-1': 'Name 1', 'uuid-2': 'Name 2' }                     â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  ['draft', entityCode, id]                      TTL: âˆ (manual)     â”‚    â”‚
â”‚  â”‚    â†’ { currentData: {...}, history: [...], canUndo, canRedo }       â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                â†“                                             â”‚
â”‚                          (persisted to)                                      â”‚
â”‚                                â†“                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Dexie IndexedDB (v4 Schema)                       â”‚    â”‚
â”‚  â”‚                  (Offline-First Persistence)                         â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  Database: pmo-cache-v4                                              â”‚    â”‚
â”‚  â”‚  Tables (8 unified with TanStack Query keys):                        â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  1. datalabel           id, data, syncedAt                          â”‚    â”‚
â”‚  â”‚  2. entityCode          code, data, syncedAt                        â”‚    â”‚
â”‚  â”‚  3. globalSetting       id, data, syncedAt                          â”‚    â”‚
â”‚  â”‚  4. entityInstanceData  id, data, syncedAt  (list data)             â”‚    â”‚
â”‚  â”‚  5. entityInstanceMetadata  id, data, syncedAt                      â”‚    â”‚
â”‚  â”‚  6. entityInstance      id, data, syncedAt  (single records)        â”‚    â”‚
â”‚  â”‚  7. entityLink          id, data, syncedAt                          â”‚    â”‚
â”‚  â”‚  8. draft               id, data            (no expiry)             â”‚    â”‚
â”‚  â”‚                                                                       â”‚    â”‚
â”‚  â”‚  Lifecycle:                                                          â”‚    â”‚
â”‚  â”‚  â€¢ App load â†’ hydrateQueryCache() â†’ Load ALL into TanStack          â”‚    â”‚
â”‚  â”‚  â€¢ Query updates â†’ Auto-sync to Dexie                                â”‚    â”‚
â”‚  â”‚  â€¢ Page refresh â†’ Instant hydration from IndexedDB                  â”‚    â”‚
â”‚  â”‚  â€¢ Multi-tab â†’ broadcastQueryClient() syncs between tabs            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cache Lifecycle States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CACHE LIFECYCLE STATE MACHINE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  STATE 1: INITIAL (Page Load)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ T=0ms:   Component mounts                                            â”‚   â”‚
â”‚  â”‚ T=0ms:   useEntityInstanceData() called                              â”‚   â”‚
â”‚  â”‚ T=0ms:   TanStack Query checks in-memory cache â†’ MISS               â”‚   â”‚
â”‚  â”‚ T=1ms:   Check Dexie IndexedDB                                       â”‚   â”‚
â”‚  â”‚ T=10ms:  Dexie HIT â†’ Hydrate TanStack Query cache                   â”‚   â”‚
â”‚  â”‚ T=10ms:  Component renders with data from Dexie (instant!)          â”‚   â”‚
â”‚  â”‚ T=10ms:  Background refetch triggered (stale-while-revalidate)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â†“                                              â”‚
â”‚  STATE 2: STALE (Background Refetch)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ T=10ms:  GET /api/v1/project?limit=20 starts                        â”‚   â”‚
â”‚  â”‚ T=150ms: API responds with fresh data                                â”‚   â”‚
â”‚  â”‚ T=150ms: TanStack Query updates cache                                â”‚   â”‚
â”‚  â”‚ T=150ms: Dexie auto-synced with new data                            â”‚   â”‚
â”‚  â”‚ T=150ms: Component re-renders with fresh data                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â†“                                              â”‚
â”‚  STATE 3: FRESH (Active Interaction)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Cache Status: FRESH (within staleTime)                               â”‚   â”‚
â”‚  â”‚ User Actions:                                                         â”‚   â”‚
â”‚  â”‚   â€¢ Inline edit â†’ Optimistic update â†’ Cache updated instantly       â”‚   â”‚
â”‚  â”‚   â€¢ Add row â†’ Temp row added â†’ Cache updated instantly              â”‚   â”‚
â”‚  â”‚   â€¢ Delete â†’ Item removed â†’ Cache updated instantly                 â”‚   â”‚
â”‚  â”‚ Background: API syncs, on success cache stays, on error rollback    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â†“                                              â”‚
â”‚  STATE 4: STALE (After staleTime)                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ T=5min:  staleTime expired                                           â”‚   â”‚
â”‚  â”‚ Behavior:                                                             â”‚   â”‚
â”‚  â”‚   â€¢ Still renders cached data                                        â”‚   â”‚
â”‚  â”‚   â€¢ Next read triggers background refetch                            â”‚   â”‚
â”‚  â”‚   â€¢ WebSocket INVALIDATE also triggers refetch                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â†“                                              â”‚
â”‚  STATE 5: INACTIVE (After gcTime)                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ T=1hour: gcTime (garbage collection time) expired                    â”‚   â”‚
â”‚  â”‚ Behavior:                                                             â”‚   â”‚
â”‚  â”‚   â€¢ TanStack Query removes from memory                               â”‚   â”‚
â”‚  â”‚   â€¢ Dexie KEEPS data (persistent)                                    â”‚   â”‚
â”‚  â”‚   â€¢ Next read â†’ Load from Dexie â†’ Trigger refetch                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Data Flow Pipeline

### Complete Request-Response-Render Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      COMPLETE DATA FLOW PIPELINE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  USER ACTION: Navigate to /project/uuid                                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                â”‚
â”‚                                                                              â”‚
â”‚  PHASE 1: QUERY INITIALIZATION (Layer 3)                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ useEntityInstanceData('project', { filters: { ... } })               â”‚   â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ TanStack Query checks cache:                                         â”‚   â”‚
â”‚  â”‚   ['entityInstanceData', 'project', { filters: { ... } }]            â”‚   â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ MISS â†’ Load from Dexie â†’ HIT â†’ Return data instantly               â”‚   â”‚
â”‚  â”‚   data = { data: [...], total, metadata, ref_data_entityInstance }  â”‚   â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ Trigger background refetch (staleTime: 5min)                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â†“                                             â”‚
â”‚  PHASE 2: API REQUEST (Layer 2)                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ GET /api/v1/project?limit=20&offset=0                               â”‚   â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ Backend (Fastify):                                                    â”‚   â”‚
â”‚  â”‚   1. RBAC check (Permission.VIEW)                                    â”‚   â”‚
â”‚  â”‚   2. Build SQL with auto-filters                                     â”‚   â”‚
â”‚  â”‚   3. Execute query with joins                                        â”‚   â”‚
â”‚  â”‚   4. Generate metadata (entity-component-metadata.service)           â”‚   â”‚
â”‚  â”‚   5. Build ref_data_entityInstance (O(1) lookup table)               â”‚   â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ Response: {                                                           â”‚   â”‚
â”‚  â”‚   data: [{ id, code, name, dl__stage, manager__employee_id, ... }], â”‚   â”‚
â”‚  â”‚   metadata: {                                                         â”‚   â”‚
â”‚  â”‚     entityListOfInstancesTable: {                                    â”‚   â”‚
â”‚  â”‚       viewType: {                                                    â”‚   â”‚
â”‚  â”‚         dl__stage: {                                                 â”‚   â”‚
â”‚  â”‚           renderType: 'badge',                                       â”‚   â”‚
â”‚  â”‚           lookupField: 'dl__project_stage'                           â”‚   â”‚
â”‚  â”‚         },                                                            â”‚   â”‚
â”‚  â”‚         manager__employee_id: {                                      â”‚   â”‚
â”‚  â”‚           renderType: 'entityInstanceId',                            â”‚   â”‚
â”‚  â”‚           lookupEntity: 'employee'                                   â”‚   â”‚
â”‚  â”‚         }                                                             â”‚   â”‚
â”‚  â”‚       },                                                              â”‚   â”‚
â”‚  â”‚       editType: { ... }                                              â”‚   â”‚
â”‚  â”‚     }                                                                 â”‚   â”‚
â”‚  â”‚   },                                                                  â”‚   â”‚
â”‚  â”‚   ref_data_entityInstance: {                                         â”‚   â”‚
â”‚  â”‚     employee: { 'uuid-1': 'James Miller', 'uuid-2': 'Sarah J' }     â”‚   â”‚
â”‚  â”‚   },                                                                  â”‚   â”‚
â”‚  â”‚   total: 42                                                           â”‚   â”‚
â”‚  â”‚ }                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â†“                                             â”‚
â”‚  PHASE 3: CACHE UPDATE (Layer 3)                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ TanStack Query onSuccess:                                            â”‚   â”‚
â”‚  â”‚   â€¢ Update in-memory cache with response                             â”‚   â”‚
â”‚  â”‚   â€¢ Auto-sync to Dexie (entityInstanceData table)                    â”‚   â”‚
â”‚  â”‚   â€¢ Trigger component re-render                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â†“                                             â”‚
â”‚  PHASE 4: FORMAT-AT-READ (Layer 4)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ useFormattedEntityData(rawData, metadata, 'project')                 â”‚   â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ Subscribe to dependencies:                                            â”‚   â”‚
â”‚  â”‚   â€¢ Datalabel cache (for badge colors)                               â”‚   â”‚
â”‚  â”‚   â€¢ EntityInstanceNames cache (for reference names)                  â”‚   â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ Format each row:                                                      â”‚   â”‚
â”‚  â”‚   formatRow(row, metadata.viewType)                                  â”‚   â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ Output: FormattedRow[] = [                                           â”‚   â”‚
â”‚  â”‚   {                                                                   â”‚   â”‚
â”‚  â”‚     raw: { dl__stage: 'planning', manager__employee_id: 'uuid-1' }, â”‚   â”‚
â”‚  â”‚     display: { dl__stage: 'Planning', manager__employee_id: 'James' },â”‚  â”‚
â”‚  â”‚     styles: { dl__stage: 'bg-blue-100 text-blue-800' }              â”‚   â”‚
â”‚  â”‚   }                                                                   â”‚   â”‚
â”‚  â”‚ ]                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â†“                                             â”‚
â”‚  PHASE 5: COMPONENT RESOLUTION (Layer 5)                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ FieldRenderer checks metadata:                                       â”‚   â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ For field 'dl__stage':                                               â”‚   â”‚
â”‚  â”‚   renderType: 'badge' â†’ ViewFieldRenderer (inline)                  â”‚   â”‚
â”‚  â”‚   Renders: <span className="bg-blue-100 text-blue-800">Planning</span> â”‚
â”‚  â”‚   â†“                                                                   â”‚   â”‚
â”‚  â”‚ For field 'manager__employee_id':                                    â”‚   â”‚
â”‚  â”‚   renderType: 'entityInstanceId' â†’ ViewFieldRenderer (inline)       â”‚   â”‚
â”‚  â”‚   Resolves: getEntityInstanceNameSync('employee', 'uuid-1')          â”‚   â”‚
â”‚  â”‚   Renders: <span>James Miller</span>                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â†“                                             â”‚
â”‚  PHASE 6: UI RENDER (Layer 6)                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ EntityListOfInstancesTable renders:                                  â”‚   â”‚
â”‚  â”‚   â€¢ Table with formatted data                                        â”‚   â”‚
â”‚  â”‚   â€¢ Badges with correct colors                                       â”‚   â”‚
â”‚  â”‚   â€¢ Entity references resolved to names                              â”‚   â”‚
â”‚  â”‚   â€¢ Click handlers attached (row click, inline edit, etc.)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. UI/UX Interaction Patterns

### The 5 Core Interaction Patterns

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI/UX INTERACTION PATTERNS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  PATTERN 1: ROW CLICK (Navigation)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚  User clicks table row â†’ Navigate to detail page                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Trigger: onClick on <tr> (row element)                               â”‚   â”‚
â”‚  â”‚ Timing: Instant (no debounce)                                        â”‚   â”‚
â”‚  â”‚ Guard:  if (shouldBlockNavigation(row.id)) return; // Block temp rowsâ”‚  â”‚
â”‚  â”‚ Action: navigate(`/${entityCode}/${row.id}`)                         â”‚   â”‚
â”‚  â”‚ State:  No state changes                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  PATTERN 2: CELL CLICK (Inline Edit - Table)                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  User clicks editable cell â†’ Enter edit mode for THAT cell only             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Trigger: onClick on <td> with inlineEditable=true                   â”‚   â”‚
â”‚  â”‚ Timing: Instant                                                       â”‚   â”‚
â”‚  â”‚ Guard:  Must be editable column, not already editing                â”‚   â”‚
â”‚  â”‚ State:  setEditingCell({ rowId, columnKey })                        â”‚   â”‚
â”‚  â”‚ Focus:  Auto-focus input/dropdown in cell                            â”‚   â”‚
â”‚  â”‚ Portal: If dropdown â†’ Renders via createPortal(menu, document.body) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  PATTERN 3: LONG-PRESS (Inline Edit - Form)                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â”‚
â”‚  User long-presses field (500ms hold) â†’ Enter inline edit mode              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Trigger: mousedown â†’ setTimeout(500ms) â†’ mouseup before timeout?    â”‚   â”‚
â”‚  â”‚ Timing: 500ms hold required (prevents accidental triggers)          â”‚   â”‚
â”‚  â”‚ Visual: Blue highlight appears during hold                           â”‚   â”‚
â”‚  â”‚ State:  setInlineEditingField(fieldKey)                             â”‚   â”‚
â”‚  â”‚         setInlineEditValue(currentValue)                             â”‚   â”‚
â”‚  â”‚ Portal: If dropdown â†’ Renders via createPortal                       â”‚   â”‚
â”‚  â”‚ Save:   Click outside or press Enter                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  PATTERN 4: DROPDOWN SELECTION (Portal-Aware)                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚  User selects from dropdown â†’ Value captured, onChange fires                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Trigger: onClick on dropdown option                                  â”‚   â”‚
â”‚  â”‚ Event:   mousedown â†’ selectOption() â†’ click                         â”‚   â”‚
â”‚  â”‚ Portal:  <div data-dropdown-portal ref={dropdownRef}>               â”‚   â”‚
â”‚  â”‚ Guard:   Parent click-outside checks:                                â”‚   â”‚
â”‚  â”‚            if (target.closest('[data-dropdown-portal]')) return;    â”‚   â”‚
â”‚  â”‚ Flow:    selectOption() â†’ onChange(value) â†’                         â”‚   â”‚
â”‚  â”‚          handleInlineValueChange(value) OR handleCellEdit(value)     â”‚   â”‚
â”‚  â”‚ Close:   setIsOpen(false) after selection                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  PATTERN 5: ADD ROW (Optimistic Temp Row)                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  User clicks "Add Row" â†’ Temp row appears instantly in edit mode            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Trigger: onClick "Add Row" button                                    â”‚   â”‚
â”‚  â”‚ Create:  newRow = { id: `temp_${Date.now()}`, _isNew: true, ... }   â”‚   â”‚
â”‚  â”‚ Cache:   queryClient.setQueryData() â†’ Append temp row               â”‚   â”‚
â”‚  â”‚ State:   setEditingRow(newRow.id)                                    â”‚   â”‚
â”‚  â”‚          setEditedData(newRow)                                       â”‚   â”‚
â”‚  â”‚          setIsAddingRow(true)                                        â”‚   â”‚
â”‚  â”‚ Render:  Table shows n+1 rows, last in edit mode                    â”‚   â”‚
â”‚  â”‚ Save:    createEntity(data, { existingTempId })                      â”‚   â”‚
â”‚  â”‚ Result:  Temp row replaced with real UUID from API                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Click-Outside Handler Pattern (Portal-Safe)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PORTAL-SAFE CLICK-OUTSIDE PATTERN                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  COMPONENT: EntityInstanceFormContainer (Form Inline Edit)                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚  useEffect(() => {                                                           â”‚
â”‚    if (!inlineEditingField) return;                                         â”‚
â”‚                                                                              â”‚
â”‚    const handleClickOutside = (event: MouseEvent) => {                      â”‚
â”‚      const target = event.target as Node;                                   â”‚
â”‚                                                                              â”‚
â”‚      // Check 1: Inside our editing field?                                  â”‚
â”‚      if (editingFieldRef.current?.contains(target)) return;                 â”‚
â”‚                                                                              â”‚
â”‚      // Check 2: Inside ANY portal dropdown? (Generic detection)            â”‚
â”‚      const isClickInsideDropdown =                                          â”‚
â”‚        (target as Element).closest?.('[data-dropdown-portal]');             â”‚
â”‚      if (isClickInsideDropdown) {                                           â”‚
â”‚        console.log('ğŸ¯ Click inside dropdown portal, ignoring');            â”‚
â”‚        return;                                                               â”‚
â”‚      }                                                                       â”‚
â”‚                                                                              â”‚
â”‚      // Truly outside - save inline edit                                    â”‚
â”‚      console.log('ğŸšª Click outside detected, saving');                      â”‚
â”‚      handleInlineSave();                                                    â”‚
â”‚    };                                                                        â”‚
â”‚                                                                              â”‚
â”‚    // Use mousedown (fires BEFORE click)                                    â”‚
â”‚    document.addEventListener('mousedown', handleClickOutside);              â”‚
â”‚    return () => document.removeEventListener('mousedown', handleClickOutside);â”‚
â”‚  }, [inlineEditingField, handleInlineSave]);                                â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  COMPONENT: EntityListOfInstancesTable (Cell Edit)                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚  useEffect(() => {                                                           â”‚
â”‚    if (!activeEditingCell) return;                                          â”‚
â”‚                                                                              â”‚
â”‚    const handleClickOutside = (event: MouseEvent) => {                      â”‚
â”‚      const target = event.target as HTMLElement;                            â”‚
â”‚                                                                              â”‚
â”‚      // Check 1: Inside editing cell?                                       â”‚
â”‚      if (editingCellRef.current?.contains(target)) return;                  â”‚
â”‚                                                                              â”‚
â”‚      // Check 2: Inside ANY portal dropdown?                                â”‚
â”‚      if (target.closest?.('[data-dropdown-portal]')) return;                â”‚
â”‚                                                                              â”‚
â”‚      // Truly outside - save cell                                           â”‚
â”‚      const record = paginatedData.find(r => getRowKey(r) === rowId);       â”‚
â”‚      if (record) {                                                           â”‚
â”‚        handleCellSave(rowId, columnKey, record);                            â”‚
â”‚      }                                                                       â”‚
â”‚    };                                                                        â”‚
â”‚                                                                              â”‚
â”‚    document.addEventListener('mousedown', handleClickOutside);              â”‚
â”‚    return () => document.removeEventListener('mousedown', handleClickOutside);â”‚
â”‚  }, [activeEditingCell]);                                                   â”‚
â”‚                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                              â”‚
â”‚  COMPONENT: BadgeDropdownSelect / EntityInstanceNameSelect                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”‚
â”‚  useEffect(() => {                                                           â”‚
â”‚    const handleClickOutside = (event: MouseEvent) => {                      â”‚
â”‚      if (                                                                    â”‚
â”‚        containerRef.current &&                                              â”‚
â”‚        !containerRef.current.contains(event.target as Node) &&              â”‚
â”‚        dropdownRef.current &&                                               â”‚
â”‚        !dropdownRef.current.contains(event.target as Node)                  â”‚
â”‚      ) {                                                                     â”‚
â”‚        setIsOpen(false);  // Close dropdown                                 â”‚
â”‚      }                                                                       â”‚
â”‚    };                                                                        â”‚
â”‚                                                                              â”‚
â”‚    document.addEventListener('mousedown', handleClickOutside);              â”‚
â”‚    return () => document.removeEventListener('mousedown', handleClickOutside);â”‚
â”‚  }, []);                                                                     â”‚
â”‚                                                                              â”‚
â”‚  KEY PRINCIPLES:                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â”‚
â”‚  1. Use 'mousedown' event (fires BEFORE click)                              â”‚
â”‚  2. Check BOTH container AND portal refs                                    â”‚
â”‚  3. Use [data-dropdown-portal] for generic detection                        â”‚
â”‚  4. Return early if click inside portal (let dropdown handle it)            â”‚
â”‚  5. Cleanup listener in useEffect return                                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Due to length constraints, I'll continue this document in a follow-up response with the remaining sections (Component Rendering, Request Flow, Inline Editing, Add Row, Cache Invalidation, and Complete Flows).

Would you like me to continue with the remaining sections?
# AI Chat System - Architecture & Design Document

## ğŸ“‹ Document Overview

**Purpose:** Complete architectural documentation of the AI Chat Widget system, including text chat and voice calling capabilities, with detailed explanation of how OpenAI LLM safely interacts with the database through function calling.

**Version:** 2.0.0
**Last Updated:** 2025-11-05
**Status:** Production Ready

---

## ğŸ—ï¸ System Architecture Overview

### High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CUSTOMER LAYER                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚   Browser    â”‚        â”‚   Browser    â”‚                          â”‚
â”‚  â”‚  (Text Chat) â”‚        â”‚ (Voice Call) â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚         â”‚                       â”‚                                    â”‚
â”‚         â”‚  HTTP/WS              â”‚  WebSocket                        â”‚
â”‚         â”‚  (Text + JSON)        â”‚  (Audio PCM16)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APPLICATION LAYER (YOUR API)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Fastify API Server (Node.js)                       â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚  Chat Routes Module                                       â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ /api/v1/chat/session/new     (HTTP POST)            â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ /api/v1/chat/message         (HTTP POST)            â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ /api/v1/chat/voice/call      (WebSocket)            â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â””â”€ /api/v1/chat/analytics       (HTTP GET)             â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚                                                                  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚  OpenAI Service Layer                                     â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ openai.service.ts     (Text Chat Completion)        â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ voice.service.ts      (Realtime Voice API)          â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â””â”€ Function Call Router                                 â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚                          â”‚                                       â”‚â”‚
â”‚  â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚â”‚
â”‚  â”‚                          â”‚                 â”‚                    â”‚â”‚
â”‚  â”‚                          â–¼                 â–¼                    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚  Function Tools Service      â”‚  â”‚  Conversation Service  â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ get_available_services   â”‚  â”‚  â”œâ”€ createSession()   â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ get_service_details      â”‚  â”‚  â”œâ”€ updateSession()   â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ get_employee_availabilityâ”‚  â”‚  â”œâ”€ closeSession()    â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ get_available_time_slots â”‚  â”‚  â””â”€ getHistory()      â”‚ â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ create_booking           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚  â”‚  â”œâ”€ get_booking_info         â”‚                             â”‚â”‚
â”‚  â”‚  â”‚  â””â”€ cancel_booking           â”‚                             â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                 â”‚                                                   â”‚
â”‚                 â”‚  SQL Queries (Parameterized)                     â”‚
â”‚                 â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EXTERNAL SERVICE LAYER                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  OpenAI API               â”‚    â”‚  Your PostgreSQL Database     â”‚â”‚
â”‚  â”‚  â”œâ”€ Chat Completions API  â”‚    â”‚  â”œâ”€ d_employee               â”‚â”‚
â”‚  â”‚  â”œâ”€ Realtime Voice API    â”‚    â”‚  â”œâ”€ d_service                â”‚â”‚
â”‚  â”‚  â”œâ”€ Function Calling      â”‚    â”‚  â”œâ”€ d_booking                â”‚â”‚
â”‚  â”‚  â””â”€ Whisper (Transcribe)  â”‚    â”‚  â”œâ”€ d_calendar               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”œâ”€ f_customer_interaction    â”‚â”‚
â”‚         â–²                          â”‚  â””â”€ (29+ other tables)        â”‚â”‚
â”‚         â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                                     â–²                      â”‚
â”‚         â”‚                                     â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                     â”‚
          â”‚  API Key: OPENAI_API_KEY           â”‚  Credentials: DB_USER
          â”‚  Model: gpt-4-turbo-preview         â”‚  Password: DB_PASSWORD
          â”‚  (Stateless, Request/Response)      â”‚  (Connection Pool)
```

---

## ğŸ”„ Function Calling Architecture

### Core Concept: The Coordinator Pattern

**The OpenAI LLM acts as an intelligent coordinator, NOT as a database client.**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FUNCTION CALLING FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: CUSTOMER SPEAKS/TYPES
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Customer: "Do you have anyone available Friday for HVAC?"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
Step 2: YOUR API FORWARDS TO OPENAI
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST https://api.openai.com/v1/chat/completions             â”‚
â”‚ {                                                             â”‚
â”‚   "model": "gpt-4-turbo-preview",                           â”‚
â”‚   "messages": [                                              â”‚
â”‚     {"role": "user", "content": "Do you have..."}           â”‚
â”‚   ],                                                          â”‚
â”‚   "functions": [                                             â”‚
â”‚     {                                                         â”‚
â”‚       "name": "get_employee_availability",                  â”‚
â”‚       "description": "Check which employees are available", â”‚
â”‚       "parameters": {                                        â”‚
â”‚         "type": "object",                                    â”‚
â”‚         "properties": {                                      â”‚
â”‚           "service_category": {"type": "string"},          â”‚
â”‚           "requested_date": {"type": "string"}             â”‚
â”‚         }                                                    â”‚
â”‚       }                                                       â”‚
â”‚     }                                                         â”‚
â”‚   ]                                                           â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
Step 3: OPENAI ANALYZES & DECIDES TO CALL FUNCTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI LLM Internal Processing:                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 1. Parse user intent: "Check availability for HVAC"   â”‚  â”‚
â”‚ â”‚ 2. Identify service: "HVAC"                           â”‚  â”‚
â”‚ â”‚ 3. Extract date: "Friday" â†’ "2025-11-08"             â”‚  â”‚
â”‚ â”‚ 4. Select function: get_employee_availability         â”‚  â”‚
â”‚ â”‚ 5. Prepare arguments                                   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â”‚ Response:                                                     â”‚
â”‚ {                                                             â”‚
â”‚   "choices": [{                                              â”‚
â”‚     "message": {                                             â”‚
â”‚       "function_call": {                                     â”‚
â”‚         "name": "get_employee_availability",               â”‚
â”‚         "arguments": "{                                     â”‚
â”‚           \"service_category\": \"HVAC\",                  â”‚
â”‚           \"requested_date\": \"2025-11-08\"               â”‚
â”‚         }"                                                   â”‚
â”‚       }                                                       â”‚
â”‚     }                                                         â”‚
â”‚   }]                                                          â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
Step 4: YOUR API RECEIVES FUNCTION CALL REQUEST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ // In openai.service.ts                                      â”‚
â”‚ if (response.choices[0].message.function_call) {             â”‚
â”‚   const functionName = "get_employee_availability";         â”‚
â”‚   const args = {                                             â”‚
â”‚     service_category: "HVAC",                               â”‚
â”‚     requested_date: "2025-11-08"                            â”‚
â”‚   };                                                          â”‚
â”‚                                                               â”‚
â”‚   // Execute YOUR function                                   â”‚
â”‚   const result = await functionTools[functionName](args);   â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
Step 5: YOUR BACKEND QUERIES YOUR DATABASE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ // In functions.service.ts                                   â”‚
â”‚ export async function getEmployeeAvailability(args) {       â”‚
â”‚   // THIS CODE RUNS ON YOUR SERVER                          â”‚
â”‚   // OPENAI NEVER SEES THIS                                 â”‚
â”‚                                                               â”‚
â”‚   const query = sql`                                         â”‚
â”‚     SELECT                                                   â”‚
â”‚       e.id::text,                                           â”‚
â”‚       e.name,                                               â”‚
â”‚       e.title,                                              â”‚
â”‚       e.department                                          â”‚
â”‚     FROM app.d_employee e                                   â”‚
â”‚     LEFT JOIN app.d_employee_calendar ec                    â”‚
â”‚       ON e.id = ec.employee_id                             â”‚
â”‚     LEFT JOIN app.d_calendar c                              â”‚
â”‚       ON c.id = ec.calendar_event_id                       â”‚
â”‚     WHERE e.department = ${args.service_category}          â”‚
â”‚       AND e.active_flag = true                             â”‚
â”‚       AND DATE(c.start_ts) = ${args.requested_date}::date â”‚
â”‚     GROUP BY e.id                                           â”‚
â”‚     HAVING COUNT(c.id) < 6                                  â”‚
â”‚   `;                                                         â”‚
â”‚                                                               â”‚
â”‚   // YOUR database connection                               â”‚
â”‚   const result = await db.execute(query);                   â”‚
â”‚                                                               â”‚
â”‚   // Format and return data                                 â”‚
â”‚   return result.rows.map(emp => ({                         â”‚
â”‚     employee_id: emp.id,                                    â”‚
â”‚     employee_name: emp.name,                                â”‚
â”‚     title: emp.title,                                       â”‚
â”‚     department: emp.department,                             â”‚
â”‚     available_slots: ["09:00", "14:00", "16:00"]          â”‚
â”‚   }));                                                       â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
Step 6: DATABASE RETURNS RESULTS TO YOUR API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query Result:                                                 â”‚
â”‚ [                                                             â”‚
â”‚   {                                                           â”‚
â”‚     employee_id: "8260b1b0-5efc-4611-ad33-ee76c0cf7f13",   â”‚
â”‚     employee_name: "James Miller",                          â”‚
â”‚     title: "HVAC Technician Lead",                          â”‚
â”‚     department: "HVAC",                                      â”‚
â”‚     available_slots: ["09:00", "14:00", "16:00"]           â”‚
â”‚   },                                                          â”‚
â”‚   {                                                           â”‚
â”‚     employee_id: "uuid-2",                                   â”‚
â”‚     employee_name: "Sarah Johnson",                         â”‚
â”‚     title: "HVAC Senior Technician",                        â”‚
â”‚     department: "HVAC",                                      â”‚
â”‚     available_slots: ["10:00", "13:00", "15:00"]           â”‚
â”‚   }                                                           â”‚
â”‚ ]                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
Step 7: YOUR API SENDS RESULTS BACK TO OPENAI
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST https://api.openai.com/v1/chat/completions             â”‚
â”‚ {                                                             â”‚
â”‚   "messages": [                                              â”‚
â”‚     {"role": "user", "content": "Do you have..."},          â”‚
â”‚     {                                                         â”‚
â”‚       "role": "function",                                    â”‚
â”‚       "name": "get_employee_availability",                  â”‚
â”‚       "content": "[{employee_name: 'James Miller'...}]"    â”‚
â”‚     }                                                         â”‚
â”‚   ]                                                           â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
Step 8: OPENAI GENERATES NATURAL RESPONSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI LLM Internal Processing:                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ 1. Parse function result data                          â”‚  â”‚
â”‚ â”‚ 2. Identify 2 available employees                      â”‚  â”‚
â”‚ â”‚ 3. Format times in natural language                    â”‚  â”‚
â”‚ â”‚ 4. Generate helpful, conversational response           â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â”‚ Response:                                                     â”‚
â”‚ {                                                             â”‚
â”‚   "choices": [{                                              â”‚
â”‚     "message": {                                             â”‚
â”‚       "role": "assistant",                                   â”‚
â”‚       "content": "Yes! I have two HVAC technicians          â”‚
â”‚                   available on Friday. James Miller has     â”‚
â”‚                   morning slots at 9 AM, or afternoon at    â”‚
â”‚                   2 PM and 4 PM. Sarah Johnson is          â”‚
â”‚                   available at 10 AM, 1 PM, and 3 PM.      â”‚
â”‚                   Which time works better for you?"         â”‚
â”‚     }                                                         â”‚
â”‚   }]                                                          â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
Step 9: YOUR API SENDS RESPONSE TO CUSTOMER
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Customer sees/hears:                                          â”‚
â”‚ "Yes! I have two HVAC technicians available on Friday.      â”‚
â”‚  James Miller has morning slots at 9 AM, or afternoon at    â”‚
â”‚  2 PM and 4 PM. Sarah Johnson is available at 10 AM,        â”‚
â”‚  1 PM, and 3 PM. Which time works better for you?"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security Architecture

### Security Boundaries

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SECURITY ZONES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Zone 1: PUBLIC (No Authentication Required)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ Chat Widget (embedded on public website)            â”‚ â”‚
â”‚  â”‚  â€¢ Voice Call (public phone-in interface)              â”‚ â”‚
â”‚  â”‚  â€¢ Text Chat (customer messaging)                      â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  Risk: Anyone can access                               â”‚ â”‚
â”‚  â”‚  Mitigation: Rate limiting, CAPTCHA, IP blocking       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                   â”‚
â”‚                           â”‚ HTTPS/WSS                        â”‚
â”‚                           â–¼                                   â”‚
â”‚  Zone 2: APPLICATION BOUNDARY (Your Backend)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ Input Validation Layer                              â”‚ â”‚
â”‚  â”‚    â”œâ”€ Sanitize all user inputs                        â”‚ â”‚
â”‚  â”‚    â”œâ”€ Validate data types and formats                 â”‚ â”‚
â”‚  â”‚    â”œâ”€ Check for SQL injection attempts                â”‚ â”‚
â”‚  â”‚    â””â”€ Rate limit per IP/session                       â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  â€¢ Function Authorization Layer                        â”‚ â”‚
â”‚  â”‚    â”œâ”€ Whitelist of allowed functions                  â”‚ â”‚
â”‚  â”‚    â”œâ”€ Argument validation per function                â”‚ â”‚
â”‚  â”‚    â”œâ”€ Business logic constraints                      â”‚ â”‚
â”‚  â”‚    â””â”€ Resource usage limits                           â”‚ â”‚
â”‚  â”‚                                                          â”‚ â”‚
â”‚  â”‚  â€¢ Data Filtering Layer                               â”‚ â”‚
â”‚  â”‚    â”œâ”€ Remove sensitive fields (SSN, salary, etc.)     â”‚ â”‚
â”‚  â”‚    â”œâ”€ Filter PII based on regulations                 â”‚ â”‚
â”‚  â”‚    â”œâ”€ Anonymize data when appropriate                 â”‚ â”‚
â”‚  â”‚    â””â”€ Apply role-based access control                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                   â”‚
â”‚                           â”‚ Parameterized SQL                â”‚
â”‚                           â–¼                                   â”‚
â”‚  Zone 3: DATA LAYER (PostgreSQL)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ Connection Pool (Limited connections)               â”‚ â”‚
â”‚  â”‚  â€¢ User Permissions (app user - read/write only)       â”‚ â”‚
â”‚  â”‚  â€¢ Network Isolation (Firewall, VPC)                  â”‚ â”‚
â”‚  â”‚  â€¢ Encrypted at Rest                                   â”‚ â”‚
â”‚  â”‚  â€¢ Audit Logging                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚  Zone 4: EXTERNAL SERVICES (OpenAI API)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ Stateless (No data persistence)                     â”‚ â”‚
â”‚  â”‚  â€¢ TLS encrypted communication                         â”‚ â”‚
â”‚  â”‚  â€¢ API Key authentication                              â”‚ â”‚
â”‚  â”‚  â€¢ Request/Response only (no callbacks)                â”‚ â”‚
â”‚  â”‚  â€¢ 30-day data retention (OpenAI policy)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### What OpenAI Can and Cannot Access

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OPENAI ACCESS MATRIX                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WHAT OPENAI SEES        â”‚  WHAT OPENAI DOES NOT SEE           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… User messages         â”‚ âŒ Database credentials              â”‚
â”‚ âœ… Function names        â”‚ âŒ Database schema                   â”‚
â”‚ âœ… Function descriptions â”‚ âŒ SQL queries                       â”‚
â”‚ âœ… Function arguments    â”‚ âŒ Connection strings                â”‚
â”‚ âœ… Function results      â”‚ âŒ Server file system                â”‚
â”‚    (filtered data)       â”‚ âŒ Environment variables             â”‚
â”‚ âœ… AI responses          â”‚ âŒ Raw database rows                 â”‚
â”‚ âœ… Conversation history  â”‚ âŒ Sensitive PII (if filtered)       â”‚
â”‚ âœ… Session metadata      â”‚ âŒ Internal API endpoints            â”‚
â”‚                          â”‚ âŒ Business logic code               â”‚
â”‚                          â”‚ âŒ Other customer sessions           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  KEY PRINCIPLE:                                                 â”‚
â”‚  OpenAI only sees the data you explicitly send in API requests â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow Security

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SECURE DATA PIPELINE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Customer Input
   â”œâ”€ Validate: Check format, length, type
   â”œâ”€ Sanitize: Remove dangerous characters
   â””â”€ Rate Limit: Block excessive requests
          â”‚
          â–¼
2. Your API Processing
   â”œâ”€ Authenticate: Verify API key to OpenAI
   â”œâ”€ Prepare: Format request payload
   â””â”€ Send: HTTPS encrypted to OpenAI
          â”‚
          â–¼
3. OpenAI Processing (External - Outside Your Control)
   â”œâ”€ LLM Analysis: Natural language understanding
   â”œâ”€ Function Selection: Choose appropriate function
   â””â”€ Return: Function call request
          â”‚
          â–¼
4. Function Execution (Your Server - Full Control)
   â”œâ”€ Validate Arguments: Check all parameters
   â”œâ”€ Authorize: Ensure function is allowed
   â”œâ”€ Execute: Run parameterized SQL query
   â”œâ”€ Filter: Remove sensitive data
   â””â”€ Return: Filtered results only
          â”‚
          â–¼
5. Database Query (Isolated - Network Restricted)
   â”œâ”€ Connection: Use connection pool
   â”œâ”€ Query: Parameterized (no SQL injection)
   â”œâ”€ Results: Raw data retrieved
   â””â”€ Return: To application layer
          â”‚
          â–¼
6. Response Filtering (Your Server - Full Control)
   â”œâ”€ Filter PII: Remove SSN, salary, etc.
   â”œâ”€ Anonymize: Hash IDs if needed
   â”œâ”€ Format: Structure for LLM
   â””â”€ Send: Back to OpenAI
          â”‚
          â–¼
7. OpenAI Response Generation
   â”œâ”€ Process: Function results
   â”œâ”€ Generate: Natural language response
   â””â”€ Return: Formatted answer
          â”‚
          â–¼
8. Your API Response
   â”œâ”€ Log: Save interaction
   â”œâ”€ Track: Update session
   â””â”€ Send: To customer
```

---

## ğŸ“Š Component Details

### 1. Chat Widget (Frontend)

**Location:** `/apps/widget/src/`

**Purpose:** User-facing interface for text and voice communication

**Components:**
```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App.tsx (Main Container)                               â”‚
â”‚  â”œâ”€ State Management                                    â”‚
â”‚  â”‚  â”œâ”€ isOpen: boolean                                 â”‚
â”‚  â”‚  â”œâ”€ sessionId: string                               â”‚
â”‚  â”‚  â”œâ”€ messages: Message[]                             â”‚
â”‚  â”‚  â””â”€ showVoiceCall: boolean                          â”‚
â”‚  â”‚                                                       â”‚
â”‚  â”œâ”€ Text Chat Interface                                 â”‚
â”‚  â”‚  â”œâ”€ Message Display                                 â”‚
â”‚  â”‚  â”œâ”€ Input Field                                     â”‚
â”‚  â”‚  â”œâ”€ Send Button                                     â”‚
â”‚  â”‚  â””â”€ Typing Indicator                                â”‚
â”‚  â”‚                                                       â”‚
â”‚  â”œâ”€ Voice Call Button                                   â”‚
â”‚  â”‚  â””â”€ Triggers VoiceCall component                    â”‚
â”‚  â”‚                                                       â”‚
â”‚  â””â”€ API Client (api.ts)                                 â”‚
â”‚     â”œâ”€ createSession()                                  â”‚
â”‚     â”œâ”€ sendMessage()                                    â”‚
â”‚     â””â”€ getHistory()                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VoiceCall.tsx (Voice Interface)                         â”‚
â”‚  â”œâ”€ WebRTC Audio Capture                                â”‚
â”‚  â”‚  â”œâ”€ getUserMedia() - Request microphone             â”‚
â”‚  â”‚  â”œâ”€ AudioContext - Process audio                    â”‚
â”‚  â”‚  â”œâ”€ ScriptProcessor - Capture audio frames         â”‚
â”‚  â”‚  â””â”€ PCM16 Conversion - Format for streaming        â”‚
â”‚  â”‚                                                       â”‚
â”‚  â”œâ”€ WebSocket Connection                                â”‚
â”‚  â”‚  â”œâ”€ Connect to /api/v1/chat/voice/call             â”‚
â”‚  â”‚  â”œâ”€ Send audio chunks (base64 encoded)             â”‚
â”‚  â”‚  â””â”€ Receive AI audio response                       â”‚
â”‚  â”‚                                                       â”‚
â”‚  â”œâ”€ Audio Playback                                      â”‚
â”‚  â”‚  â”œâ”€ Audio queue management                          â”‚
â”‚  â”‚  â”œâ”€ PCM16 â†’ Float32 conversion                      â”‚
â”‚  â”‚  â”œâ”€ AudioBuffer creation                            â”‚
â”‚  â”‚  â””â”€ Speaker output                                   â”‚
â”‚  â”‚                                                       â”‚
â”‚  â””â”€ UI Components                                        â”‚
â”‚     â”œâ”€ Status Indicators (Listening, Speaking)         â”‚
â”‚     â”œâ”€ Transcript Display                              â”‚
â”‚     â””â”€ End Call Button                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Data Flow:**
```
User Action â†’ State Update â†’ API Call â†’ Response â†’ UI Update
```

---

### 2. API Server (Backend)

**Location:** `/apps/api/src/`

**Purpose:** Backend service managing all communication and business logic

**Architecture:**
```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fastify Server (server.ts)                                  â”‚
â”‚  â”œâ”€ Plugins                                                  â”‚
â”‚  â”‚  â”œâ”€ CORS (Allow widget origins)                          â”‚
â”‚  â”‚  â”œâ”€ Rate Limiting (100 req/min)                          â”‚
â”‚  â”‚  â”œâ”€ JWT (Authentication for admin endpoints)             â”‚
â”‚  â”‚  â”œâ”€ Multipart (File uploads)                             â”‚
â”‚  â”‚  â””â”€ WebSocket (@fastify/websocket)                       â”‚
â”‚  â”‚                                                            â”‚
â”‚  â”œâ”€ Route Modules                                            â”‚
â”‚  â”‚  â”œâ”€ /api/v1/chat/* (Chat routes)                         â”‚
â”‚  â”‚  â”œâ”€ /api/v1/booking/* (Booking CRUD)                     â”‚
â”‚  â”‚  â””â”€ /api/v1/* (Other entity routes)                      â”‚
â”‚  â”‚                                                            â”‚
â”‚  â””â”€ Error Handling                                           â”‚
â”‚     â”œâ”€ 400 Bad Request (Validation errors)                  â”‚
â”‚     â”œâ”€ 404 Not Found (Resource missing)                     â”‚
â”‚     â”œâ”€ 500 Internal Error (Logged and sanitized)            â”‚
â”‚     â””â”€ Custom Error Types (ChatError, DBError)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Chat Module (Backend)

**Location:** `/apps/api/src/modules/chat/`

**Purpose:** Handle chat sessions, message processing, and AI integration

**Files & Responsibilities:**

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  routes.ts - HTTP Endpoints                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  POST /session/new                                     â”‚ â”‚
â”‚  â”‚  â”œâ”€ Create new customer interaction                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ Generate interaction number (INT-YYYY-00001)      â”‚ â”‚
â”‚  â”‚  â”œâ”€ Generate greeting message                         â”‚ â”‚
â”‚  â”‚  â””â”€ Return session_id                                 â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  POST /message                                         â”‚ â”‚
â”‚  â”‚  â”œâ”€ Receive customer message                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ Get conversation history                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ Call OpenAI with message + functions             â”‚ â”‚
â”‚  â”‚  â”œâ”€ Process function calls (if any)                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ Update conversation in database                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ Track costs and tokens                           â”‚ â”‚
â”‚  â”‚  â””â”€ Return AI response                                â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  GET /session/:id/history                             â”‚ â”‚
â”‚  â”‚  â”œâ”€ Fetch conversation from database                  â”‚ â”‚
â”‚  â”‚  â””â”€ Return message array                              â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  POST /session/:id/close                              â”‚ â”‚
â”‚  â”‚  â”œâ”€ Mark session as closed                            â”‚ â”‚
â”‚  â”‚  â”œâ”€ Set resolution status                             â”‚ â”‚
â”‚  â”‚  â””â”€ Calculate final metrics                           â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  GET /analytics/recent                                â”‚ â”‚
â”‚  â”‚  â”œâ”€ Query f_customer_interaction table                â”‚ â”‚
â”‚  â”‚  â”œâ”€ Aggregate statistics                              â”‚ â”‚
â”‚  â”‚  â””â”€ Return metrics                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  voice.routes.ts - WebSocket Endpoint                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  WS /voice/call                                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Accept WebSocket connection                       â”‚ â”‚
â”‚  â”‚  â”œâ”€ Create interaction session                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Initialize VoiceSession instance                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ Connect to OpenAI Realtime API                    â”‚ â”‚
â”‚  â”‚  â”œâ”€ Stream audio bidirectionally                      â”‚ â”‚
â”‚  â”‚  â””â”€ Handle disconnect and cleanup                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  openai.service.ts - Text Chat Integration                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  getAIResponse(conversationHistory, sessionId)        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Convert chat messages to OpenAI format            â”‚ â”‚
â”‚  â”‚  â”œâ”€ Add system prompt with instructions               â”‚ â”‚
â”‚  â”‚  â”œâ”€ Include function definitions                      â”‚ â”‚
â”‚  â”‚  â”œâ”€ Call OpenAI Chat Completions API                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ Check for function_call in response               â”‚ â”‚
â”‚  â”‚  â”œâ”€ Execute function if requested                     â”‚ â”‚
â”‚  â”‚  â”œâ”€ Send function result back to OpenAI               â”‚ â”‚
â”‚  â”‚  â”œâ”€ Get final AI response                             â”‚ â”‚
â”‚  â”‚  â”œâ”€ Calculate token usage                             â”‚ â”‚
â”‚  â”‚  â””â”€ Return {response, functionCalls, tokensUsed}      â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  FUNCTION_DEFINITIONS                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ Array of 7 function specifications                â”‚ â”‚
â”‚  â”‚  â”œâ”€ Each includes: name, description, parameters      â”‚ â”‚
â”‚  â”‚  â””â”€ Sent to OpenAI with every request                 â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  calculateCost(tokens)                                 â”‚ â”‚
â”‚  â”‚  â””â”€ Estimate cost based on GPT-4 pricing              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  voice.service.ts - Voice Realtime Integration               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  VoiceSession Class                                    â”‚ â”‚
â”‚  â”‚  â”œâ”€ connect()                                          â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Open WebSocket to OpenAI Realtime API          â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Configure session (voice, VAD, functions)      â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Set up bidirectional streaming                 â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â”œâ”€ handleClientMessage(data)                         â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Receive audio from customer                    â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Forward to OpenAI (input_audio_buffer.append) â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Handle cancel/commit events                    â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â”œâ”€ handleOpenAIMessage(data)                         â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Receive audio from AI                          â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Forward to customer (response.audio.delta)     â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Handle transcripts                             â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Process function calls                         â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â”œâ”€ handleFunctionCall(message)                       â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Parse function name and arguments              â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Execute function tool                          â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Send result back to OpenAI                     â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Request AI to continue                         â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â””â”€ cleanup()                                          â”‚ â”‚
â”‚  â”‚     â”œâ”€ Close WebSocket connections                    â”‚ â”‚
â”‚  â”‚     â””â”€ Free resources                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  conversation.service.ts - Session Management                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  createSession(customerInfo)                           â”‚ â”‚
â”‚  â”‚  â”œâ”€ Generate unique session ID (UUID)                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ Generate interaction number                       â”‚ â”‚
â”‚  â”‚  â”œâ”€ Lookup customer if ID provided                    â”‚ â”‚
â”‚  â”‚  â”œâ”€ Insert into f_customer_interaction                â”‚ â”‚
â”‚  â”‚  â””â”€ Return session_id and interaction_number          â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  getSession(sessionId)                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ Query f_customer_interaction by ID                â”‚ â”‚
â”‚  â”‚  â”œâ”€ Parse JSON conversation_history                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ Check for linked booking                          â”‚ â”‚
â”‚  â”‚  â””â”€ Return ChatSession object                         â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  updateSession(sessionId, messages, metadata)         â”‚ â”‚
â”‚  â”‚  â”œâ”€ Build conversation text summary                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ Calculate sentiment (basic heuristics)            â”‚ â”‚
â”‚  â”‚  â”œâ”€ Update conversation_history (JSONB)               â”‚ â”‚
â”‚  â”‚  â”œâ”€ Update metadata (tokens, cost, model)             â”‚ â”‚
â”‚  â”‚  â”œâ”€ Calculate duration                                â”‚ â”‚
â”‚  â”‚  â””â”€ Set booking flags if booking created              â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  closeSession(sessionId, resolution)                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ Set resolution_status                             â”‚ â”‚
â”‚  â”‚  â””â”€ Update timestamps                                  â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  getRecentInteractions(limit)                         â”‚ â”‚
â”‚  â”‚  â””â”€ Query recent chat sessions for analytics          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  functions.service.ts - Function Tools (THE HEART)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  THIS IS WHERE DATABASE MAGIC HAPPENS                  â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  getAvailableServices(args)                            â”‚ â”‚
â”‚  â”‚  â”œâ”€ Query: SELECT * FROM d_service                     â”‚ â”‚
â”‚  â”‚  â”œâ”€ Filter: By service_category if provided           â”‚ â”‚
â”‚  â”‚  â””â”€ Return: Service list with pricing                 â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  getServiceDetails(args)                               â”‚ â”‚
â”‚  â”‚  â”œâ”€ Query: SELECT * FROM d_service WHERE id = ?       â”‚ â”‚
â”‚  â”‚  â””â”€ Return: Detailed service info                      â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  getEmployeeAvailability(args)                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Query: d_employee JOIN d_employee_calendar        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Filter: By department and date                    â”‚ â”‚
â”‚  â”‚  â”œâ”€ Check: Calendar conflicts                         â”‚ â”‚
â”‚  â”‚  â””â”€ Return: List of available employees               â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  getAvailableTimeSlots(args)                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ Query: d_calendar for employee                    â”‚ â”‚
â”‚  â”‚  â”œâ”€ Calculate: Free slots (9 AM - 5 PM)               â”‚ â”‚
â”‚  â”‚  â””â”€ Return: Available time slots                       â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  create_booking(args, interactionSessionId) â­        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Validate: All required fields                     â”‚ â”‚
â”‚  â”‚  â”œâ”€ Query: d_service for pricing                      â”‚ â”‚
â”‚  â”‚  â”œâ”€ Generate: Booking number (BK-YYYY-000001)         â”‚ â”‚
â”‚  â”‚  â”œâ”€ Insert: INTO d_booking with all details           â”‚ â”‚
â”‚  â”‚  â”œâ”€ Insert: INTO d_entity_instance_id (registry)      â”‚ â”‚
â”‚  â”‚  â”œâ”€ Link: To interaction session                      â”‚ â”‚
â”‚  â”‚  â””â”€ Return: Booking confirmation                       â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  getBookingInfo(args)                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ Query: d_booking by booking_number                â”‚ â”‚
â”‚  â”‚  â””â”€ Return: Booking details                            â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  cancelBooking(args)                                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ Update: d_booking set status = 'cancelled'        â”‚ â”‚
â”‚  â”‚  â”œâ”€ Set: cancellation_reason and timestamp            â”‚ â”‚
â”‚  â”‚  â””â”€ Return: Success confirmation                       â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  EXPORTED:                                             â”‚ â”‚
â”‚  â”‚  export const functionTools = {                        â”‚ â”‚
â”‚  â”‚    get_available_services,                            â”‚ â”‚
â”‚  â”‚    get_service_details,                               â”‚ â”‚
â”‚  â”‚    get_employee_availability,                         â”‚ â”‚
â”‚  â”‚    get_available_time_slots,                          â”‚ â”‚
â”‚  â”‚    create_booking,                                     â”‚ â”‚
â”‚  â”‚    get_booking_info,                                   â”‚ â”‚
â”‚  â”‚    cancel_booking                                      â”‚ â”‚
â”‚  â”‚  };                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  types.ts - TypeScript Interfaces                            â”‚
â”‚  â”œâ”€ ChatMessage (role, content, timestamp)                  â”‚
â”‚  â”œâ”€ ChatSession (session data structure)                    â”‚
â”‚  â”œâ”€ FunctionCallResult (function execution result)          â”‚
â”‚  â”œâ”€ BookingRequest (booking creation parameters)            â”‚
â”‚  â”œâ”€ BookingResponse (booking confirmation)                  â”‚
â”‚  â””â”€ OpenAI API types (messages, functions, responses)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Critical Function Calling Details

### How LLM Decides Which Function to Call

The LLM uses several factors to decide:

1. **User Intent Analysis**
   ```
   "Do you have anyone available Friday?"
   â†’ Intent: CHECK_AVAILABILITY
   â†’ Required function: get_employee_availability
   ```

2. **Function Descriptions** (provided in every API call)
   ```typescript
   {
     name: 'get_employee_availability',
     description: 'Check which employees are available to perform
                   a service on a specific date',
     parameters: {
       service_category: 'Service type (HVAC, Plumbing, etc.)',
       requested_date: 'Date in YYYY-MM-DD format'
     }
   }
   ```

3. **Context from Conversation**
   ```
   Previous messages:
   User: "I need HVAC service"
   AI: "Great! What date works for you?"
   User: "Next Friday"

   â†’ LLM knows service_category = "HVAC"
   â†’ LLM converts "Next Friday" to "2025-11-08"
   ```

4. **Multi-Step Function Calling**
   ```
   Step 1: get_employee_availability(HVAC, 2025-11-08)
           â†’ Returns: [James Miller, Sarah Johnson]

   Step 2: AI asks user to choose time

   Step 3: create_booking(all collected info)
           â†’ Returns: Booking confirmation
   ```

### Function Call Validation

**Your backend MUST validate everything:**

```typescript
export async function createBooking(args: BookingRequest) {
  // 1. Validate required fields
  if (!args.service_id || !args.customer_name || !args.customer_phone) {
    throw new Error('Missing required booking information');
  }

  // 2. Validate formats
  if (!/^\d{3}-\d{3}-\d{4}$/.test(args.customer_phone)) {
    throw new Error('Invalid phone number format');
  }

  // 3. Validate business logic
  const requestedDate = new Date(args.requested_date);
  const today = new Date();
  if (requestedDate < today) {
    throw new Error('Cannot book in the past');
  }

  // 4. Verify referenced entities exist
  const service = await getServiceById(args.service_id);
  if (!service) {
    throw new Error('Service not found');
  }

  // 5. Check business constraints
  const bookingCount = await countBookingsForSession(sessionId);
  if (bookingCount >= 3) {
    throw new Error('Maximum bookings per session reached');
  }

  // 6. Execute database operation
  // ... SQL query here ...

  // 7. Return sanitized result
  return {
    booking_id: result.id,
    booking_number: result.booking_number,
    // DO NOT include: internal IDs, sensitive data
  };
}
```

---

## ğŸ”„ Complete Interaction Flows

### Flow 1: Simple Question (No Function Call)

```
Customer: "What are your business hours?"
     â”‚
     â–¼
YOUR API â†’ OpenAI: {
  messages: [
    {role: "system", content: "You are assistant..."},
    {role: "user", content: "What are your business hours?"}
  ]
}
     â”‚
     â–¼
OpenAI Analyzes:
  - Intent: INFORMATION_REQUEST
  - Info in system prompt: "Monday-Friday 8AM-6PM..."
  - Decision: Answer directly (no function needed)
     â”‚
     â–¼
OpenAI â†’ YOUR API: {
  message: {
    role: "assistant",
    content: "We're open Monday to Friday from 8 AM to 6 PM,
              Saturday 9 AM to 5 PM, and closed Sunday.
              We also offer 24/7 emergency services for
              HVAC and plumbing!"
  }
}
     â”‚
     â–¼
YOUR API â†’ Customer: [Display response]
```

### Flow 2: Single Function Call

```
Customer: "What HVAC services do you offer?"
     â”‚
     â–¼
YOUR API â†’ OpenAI: {
  messages: [{role: "user", content: "What HVAC services..."}],
  functions: [FUNCTION_DEFINITIONS]
}
     â”‚
     â–¼
OpenAI Analyzes:
  - Intent: LIST_SERVICES
  - Category: HVAC
  - Decision: Call get_available_services
     â”‚
     â–¼
OpenAI â†’ YOUR API: {
  message: {
    function_call: {
      name: "get_available_services",
      arguments: '{"service_category": "HVAC"}'
    }
  }
}
     â”‚
     â–¼
YOUR API Executes Function:
  const result = await getAvailableServices({
    service_category: "HVAC"
  });
  // Queries: SELECT * FROM d_service WHERE service_category = 'HVAC'
  // Returns: [
  //   {id: "uuid-1", name: "HVAC Maintenance", price: 150},
  //   {id: "uuid-2", name: "HVAC Repair", price: 200},
  //   ...
  // ]
     â”‚
     â–¼
YOUR API â†’ OpenAI: {
  messages: [
    {role: "user", content: "What HVAC services..."},
    {
      role: "function",
      name: "get_available_services",
      content: '[{name: "HVAC Maintenance"...}]'
    }
  ]
}
     â”‚
     â–¼
OpenAI Generates Response:
  "We offer several HVAC services:
   â€¢ HVAC Maintenance ($150) - System inspection and tune-up
   â€¢ HVAC Repair ($200) - Fix heating and cooling issues
   â€¢ HVAC Installation ($3500) - New system installation
   â€¢ Emergency HVAC Service ($300) - 24/7 urgent repairs

   Which service are you interested in?"
     â”‚
     â–¼
Customer sees natural, helpful response
```

### Flow 3: Multi-Function Call (Booking Creation)

```
Customer: "I want to book HVAC maintenance for next Friday"
     â”‚
     â–¼
[OpenAI calls get_available_services to find HVAC maintenance]
     â”‚
     â–¼
[OpenAI calls get_employee_availability for next Friday]
     â”‚
     â–¼
AI: "Great! I have technicians available. Can I get your name?"
     â”‚
     â–¼
Customer: "John Smith"
     â”‚
     â–¼
AI: "Thanks John! What's your phone number?"
     â”‚
     â–¼
Customer: "416-555-1234"
     â”‚
     â–¼
AI: "And your service address?"
     â”‚
     â–¼
Customer: "123 Main St, Toronto"
     â”‚
     â–¼
[OpenAI has all info, calls create_booking function]
     â”‚
     â–¼
YOUR API Executes:
  const result = await createBooking({
    service_id: "uuid-hvac-maintenance",
    customer_name: "John Smith",
    customer_phone: "416-555-1234",
    customer_address: "123 Main St, Toronto",
    customer_city: "Toronto",
    requested_date: "2025-11-08",
    requested_time_start: "14:00"
  });

  // Executes:
  // 1. INSERT INTO d_booking (...)
  // 2. INSERT INTO d_entity_instance_id (...)
  // 3. UPDATE f_customer_interaction SET booking_created_flag = true

  // Returns:
  // {
  //   booking_id: "uuid-123",
  //   booking_number: "BK-2025-000007",
  //   service_name: "HVAC Maintenance",
  //   requested_date: "2025-11-08",
  //   estimated_cost: 150
  // }
     â”‚
     â–¼
AI: "Perfect! I've booked your HVAC maintenance for Friday,
     November 8th at 2 PM. Your confirmation number is
     BK-2025-000007. We'll send you a text reminder the day
     before. Is there anything else I can help you with?"
```

---

## ğŸ“ˆ Performance & Scalability

### Performance Metrics

| Metric | Text Chat | Voice Call |
|--------|-----------|------------|
| **Initial Connection** | 100-200ms | 300-500ms |
| **Message Processing** | 1-2 seconds | Real-time |
| **Function Execution** | 100-300ms | 100-300ms |
| **Total Turn Time** | 1.5-3 seconds | 2-3 seconds |
| **Concurrent Users** | 1000+ per server | 100-200 per server |
| **Database Queries** | 1-3 per turn | 1-3 per turn |

### Scalability Considerations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            HORIZONTAL SCALING STRATEGY                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  Load Balancer (NGINX/AWS ALB)                          â”‚
â”‚         â”‚                                                 â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚         â–¼             â–¼             â–¼              â–¼    â”‚
â”‚    API Server 1  API Server 2  API Server 3  API Server N â”‚
â”‚         â”‚             â”‚             â”‚              â”‚    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       â”‚                                  â”‚
â”‚                       â–¼                                  â”‚
â”‚            PostgreSQL (Connection Pool)                  â”‚
â”‚            â”œâ”€ Primary (Write)                           â”‚
â”‚            â””â”€ Replicas (Read) x N                       â”‚
â”‚                                                           â”‚
â”‚  Stateless Design:                                       â”‚
â”‚  â”œâ”€ No server-side session storage                      â”‚
â”‚  â”œâ”€ All state in database or client                     â”‚
â”‚  â”œâ”€ Can add/remove servers dynamically                  â”‚
â”‚  â””â”€ WebSocket sticky sessions for voice                 â”‚
â”‚                                                           â”‚
â”‚  Database Optimization:                                  â”‚
â”‚  â”œâ”€ Connection pooling (max 20 per server)              â”‚
â”‚  â”œâ”€ Query optimization (indexes on common lookups)      â”‚
â”‚  â”œâ”€ Read replicas for high-read operations              â”‚
â”‚  â””â”€ Caching layer (Redis) for frequently accessed data  â”‚
â”‚                                                           â”‚
â”‚  OpenAI Rate Limiting:                                   â”‚
â”‚  â”œâ”€ TPM Limit: 10,000 tokens/min (monitor usage)        â”‚
â”‚  â”œâ”€ RPM Limit: 60 requests/min per account              â”‚
â”‚  â”œâ”€ Queue requests if hitting limits                    â”‚
â”‚  â””â”€ Fallback to cached responses for common questions   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Best Practices

### 1. Function Design Principles

```typescript
// âœ… GOOD: Specific, well-defined function
export async function getEmployeeAvailability(args: {
  service_category: string;
  requested_date: string;
}) {
  // Clear inputs, clear outputs
  // Validates inputs
  // Single responsibility
}

// âŒ BAD: Generic, unclear function
export async function getData(args: any) {
  // What data? From where? Why?
}
```

### 2. Data Filtering

```typescript
// âœ… GOOD: Filter sensitive data
export async function getEmployeeInfo(args) {
  const result = await db.query(...);

  return result.rows.map(emp => ({
    name: emp.name,             // âœ… Send
    title: emp.title,           // âœ… Send
    available: emp.available,   // âœ… Send
    // salary: emp.salary,      // âŒ Don't send
    // ssn: emp.ssn,            // âŒ Don't send
    // home_address: emp.addr   // âŒ Don't send
  }));
}
```

### 3. Error Handling

```typescript
// âœ… GOOD: Detailed error handling
export async function createBooking(args) {
  try {
    // Validate
    if (!args.customer_phone) {
      throw new ValidationError('Phone number required');
    }

    // Execute
    const result = await db.query(...);

    // Success
    return { success: true, booking: result };

  } catch (error) {
    if (error instanceof ValidationError) {
      // User-friendly error for LLM
      throw new Error(`I need your phone number to complete the booking`);
    } else {
      // Log detailed error
      console.error('Booking creation failed:', error);
      // Generic error for LLM
      throw new Error('Unable to create booking. Please try again.');
    }
  }
}
```

### 4. Rate Limiting

```typescript
// Per-session limits
const sessionLimits = new Map<string, {
  messageCount: number;
  bookingCount: number;
  startTime: Date;
}>();

export async function checkRateLimit(sessionId: string) {
  const limits = sessionLimits.get(sessionId) || {
    messageCount: 0,
    bookingCount: 0,
    startTime: new Date()
  };

  // Max 50 messages per session
  if (limits.messageCount >= 50) {
    throw new Error('Message limit reached for this session');
  }

  // Max 3 bookings per session
  if (limits.bookingCount >= 3) {
    throw new Error('Booking limit reached for this session');
  }

  limits.messageCount++;
  sessionLimits.set(sessionId, limits);
}
```

---

## ğŸ“š Summary

### Key Architectural Principles

1. **Separation of Concerns**
   - LLM = Coordinator (understands intent)
   - Your Backend = Executor (controls data)
   - Database = Source of Truth (isolated)

2. **Security by Design**
   - LLM never accesses database directly
   - All queries go through your validation layer
   - Sensitive data filtered before sending to LLM
   - Parameterized queries prevent SQL injection

3. **Stateless Architecture**
   - No server-side session storage
   - All state in database
   - Horizontally scalable
   - WebSocket sticky sessions for voice

4. **Function Calling Pattern**
   - Well-defined function contracts
   - Clear input validation
   - Filtered output data
   - Error handling and fallbacks

5. **Real-time Capabilities**
   - Text chat: HTTP request/response
   - Voice call: WebSocket streaming
   - Both use same function tools
   - Unified database integration

---

## ğŸ” Additional Resources

**Code Locations:**
- Widget: `/apps/widget/src/`
- API: `/apps/api/src/`
- Chat Module: `/apps/api/src/modules/chat/`
- Function Tools: `/apps/api/src/modules/chat/functions.service.ts`
- Database Schema: `/db/`

**Related Documentation:**
- `README.md` - Feature overview
- `TECHNICAL_IMPLEMENTATION.md` - Implementation details
- `DEPLOYMENT_GUIDE.md` - Deployment instructions
- `VOICE_CALLING_GUIDE.md` - Voice-specific guide

---

**Document Version:** 2.0.0
**Last Updated:** 2025-11-05
**Authors:** System Architecture Team
**Status:** âœ… Production Ready

# Auto Label→UUID Mapping Generation

**Version**: 1.0.0
**Date**: 2025-01-18
**Status**: ✅ Production Ready

## Overview

Automatically generates label→UUID field mappings when API data arrives at the frontend. No manual mapping generation required.

**How It Works**:
1. API response arrives (e.g., `/api/v1/project/abc-123`)
2. Axios interceptor extracts data
3. Mapping generator detects UUID field patterns
4. Mapping stored in global context
5. Components access mapping via hook

**Result**: Every API response automatically populates the mapping cache.

---

## Architecture

```
API Response
    ↓
Axios Response Interceptor (api.ts)
    ↓
Generate label→UUID mapping (labelToUuidFieldMapper.ts)
    ↓
Store in Context (LabelToUuidMappingContext)
    ↓
Components access via hook (useLabelToUuidMappingContext)
```

---

## Files Created

| File | Purpose |
|------|---------|
| `contexts/LabelToUuidMappingContext.tsx` | Global mapping cache with React Context |
| `lib/api.ts` (updated) | Axios response interceptor for auto-generation |
| `App.tsx` (updated) | Provider integration and context registration |

---

## Usage in Components

### Example 1: EntityFormContainer - Access Cached Mapping

```typescript
import { useLabelToUuidMappingContext } from '@/contexts/LabelToUuidMappingContext';

interface EntityFormContainerProps {
  entityType: string;
  entityId: string;
  data: Record<string, any>;
  onChange: (field: string, value: any) => void;
}

export const EntityFormContainer: React.FC<EntityFormContainerProps> = ({
  entityType,
  entityId,
  data,
  onChange
}) => {
  // Access global mapping cache
  const { getMapping, getMappingFromData } = useLabelToUuidMappingContext();

  // Try to get cached mapping first
  let mapping = getMapping(entityType, entityId);

  // Fallback: Generate on-the-fly if not cached
  if (!mapping) {
    mapping = getMappingFromData(data);
  }

  // Render form fields
  return (
    <div className="space-y-4">
      {Object.entries(mapping).map(([labelField, info]) => (
        <div key={labelField}>
          <label>{labelField}</label>
          <select
            value={data[info.uuidField] || ''}
            onChange={(e) => {
              // Update UUID field when dropdown changes
              onChange(info.uuidField, e.target.value);
            }}
          >
            {/* Options loaded from /api/v1/entity/{info.entityType}/options */}
          </select>
        </div>
      ))}
    </div>
  );
};
```

### Example 2: EntityDetailPage - Check If Mapping Exists

```typescript
import { useLabelToUuidMappingContext } from '@/contexts/LabelToUuidMappingContext';
import { useParams } from 'react-router-dom';

export const EntityDetailPage: React.FC<{ entityType: string }> = ({ entityType }) => {
  const { id } = useParams();
  const { getMapping } = useLabelToUuidMappingContext();

  const [data, setData] = useState<any>(null);

  useEffect(() => {
    // Fetch entity data
    const fetchData = async () => {
      const response = await apiClient.get(`/api/v1/${entityType}/${id}`);
      setData(response.data);

      // Mapping automatically generated by interceptor!
      // Check if it worked:
      const mapping = getMapping(entityType, id);
      console.log('Auto-generated mapping:', mapping);
    };

    fetchData();
  }, [entityType, id]);

  return <div>{/* Render entity */}</div>;
};
```

### Example 3: List Page - Mappings for All Items

```typescript
import { useLabelToUuidMappingContext } from '@/contexts/LabelToUuidMappingContext';

export const EntityMainPage: React.FC<{ entityType: string }> = ({ entityType }) => {
  const { getMapping } = useLabelToUuidMappingContext();
  const [items, setItems] = useState<any[]>([]);

  useEffect(() => {
    const fetchItems = async () => {
      const response = await apiClient.get(`/api/v1/${entityType}`);
      setItems(response.data.data || response.data);

      // ALL items now have mappings in cache!
      response.data.data.forEach((item: any) => {
        const mapping = getMapping(entityType, item.id);
        console.log(`Mapping for ${item.id}:`, mapping);
      });
    };

    fetchItems();
  }, [entityType]);

  return <div>{/* Render items */}</div>;
};
```

---

## API Interceptor Details

### Response Processing

The interceptor handles 3 response types:

1. **Single Entity Response**:
```json
{
  "id": "abc-123",
  "name": "Kitchen Renovation",
  "manager__employee_id": "emp-456",
  "manager": "James Miller"
}
```
→ Generates mapping for `project:abc-123`

2. **Array Response**:
```json
[
  { "id": "abc-123", "manager__employee_id": "emp-456", "manager": "James Miller" },
  { "id": "def-789", "sponsor__employee_id": "emp-999", "sponsor": "Sarah Johnson" }
]
```
→ Generates mappings for `project:abc-123` and `project:def-789`

3. **Paginated Response**:
```json
{
  "data": [
    { "id": "abc-123", "manager__employee_id": "emp-456", "manager": "James Miller" }
  ],
  "total": 100,
  "page": 1
}
```
→ Generates mapping for each item in `data` array

### URL-Based Entity Type Detection

```typescript
// Interceptor extracts entity type from URL:
"/api/v1/project/abc-123" → "project"
"/api/v1/employee/xyz-789" → "employee"
"/api/v1/task?limit=10" → "task"
```

---

## Context API Reference

### `useLabelToUuidMappingContext()`

Returns:
```typescript
{
  getMapping: (entityType: string, entityId: string) => LabelToUuidMapping | undefined,
  getMappingFromData: (data: Record<string, any>) => LabelToUuidMapping,
  setMapping: (entityType: string, entityId: string, mapping: LabelToUuidMapping) => void,
  setMappingFromData: (entityType: string, entityId: string, data: Record<string, any>) => void,
  clearMappings: () => void,
  getAllMappings: () => MappingCache
}
```

#### Method Details

**`getMapping(entityType, entityId)`**
- Returns cached mapping for specific entity
- Returns `undefined` if not cached
- Example: `getMapping('project', 'abc-123')`

**`getMappingFromData(data)`**
- Generates mapping on-the-fly from data object
- Does NOT cache result
- Use when you have data but it's not in cache

**`setMapping(entityType, entityId, mapping)`**
- Manually set mapping for entity (rarely needed)
- Usually called by interceptor

**`setMappingFromData(entityType, entityId, data)`**
- Generate and cache mapping from data
- Called by interceptor automatically

**`clearMappings()`**
- Clear all cached mappings
- Use on logout

**`getAllMappings()`**
- Get entire cache (for debugging)
- Returns `{ "project:abc-123": {...}, "task:def-456": {...} }`

---

## Cache Structure

```typescript
{
  // Cache key format: "{entityType}:{entityId}"
  "project:abc-123": {
    "manager": {
      uuidField: "manager__employee_id",
      entityType: "employee",
      multiple: false
    },
    "stakeholder": {
      uuidField: "stakeholder__employee_ids",
      entityType: "employee",
      multiple: true
    }
  },
  "task:def-456": {
    "assignee": {
      uuidField: "assignee__employee_id",
      entityType: "employee",
      multiple: false
    }
  }
}
```

---

## Integration with useLabelToUuidMapping Hook

The auto-generation works seamlessly with the existing `useLabelToUuidMapping` hook:

```typescript
import { useLabelToUuidMapping } from '@/hooks/useLabelToUuidMapping';
import { useLabelToUuidMappingContext } from '@/contexts/LabelToUuidMappingContext';

const MyComponent = ({ entityType, entityId, data }) => {
  const { getMapping } = useLabelToUuidMappingContext();

  // Try cached first
  const cachedMapping = getMapping(entityType, entityId);

  // Use hook for helpers (works with cached or fresh data)
  const {
    mapping,
    getUuidFieldName,
    isMultiple
  } = useLabelToUuidMapping(cachedMapping ? {} : data);

  // If cached, use cached mapping
  const finalMapping = cachedMapping || mapping;

  return <div>{/* Use finalMapping */}</div>;
};
```

---

## Performance Benefits

### Before Auto-Generation

```typescript
// Manual mapping generation on every component render
const MyComponent = ({ data }) => {
  const mapping = generateLabelToUuidMapping(data); // ❌ Recalculated every render
  // ...
};
```

### After Auto-Generation

```typescript
// Cached mapping, zero recalculation
const MyComponent = ({ entityType, entityId }) => {
  const { getMapping } = useLabelToUuidMappingContext();
  const mapping = getMapping(entityType, entityId); // ✅ Instant lookup
  // ...
};
```

**Benefits**:
- ✅ **Zero recalculation**: Mapping generated once per API response
- ✅ **Instant access**: O(1) lookup from cache
- ✅ **Memory efficient**: Single mapping per entity (not per component)
- ✅ **Automatic**: No manual generation needed

---

## Error Handling

The interceptor includes error handling:

```typescript
apiClient.interceptors.response.use((response) => {
  try {
    // Generate mappings...
  } catch (error) {
    // Don't break API responses if mapping generation fails
    console.error('Error generating label→UUID mapping from API response:', error);
  }

  return response; // Always return response
});
```

**Result**: API responses continue working even if mapping generation fails.

---

## Debugging

### Check Cache Contents

```typescript
const { getAllMappings } = useLabelToUuidMappingContext();

console.log('Current cache:', getAllMappings());
// Output:
// {
//   "project:abc-123": {...},
//   "task:def-456": {...}
// }
```

### Verify Interceptor Registration

```typescript
// In browser console after app loads:
console.log('Axios interceptors:', apiClient.interceptors.response.handlers);
// Should show response interceptor registered
```

### Check Mapping for Specific Entity

```typescript
const { getMapping } = useLabelToUuidMappingContext();

// After fetching project abc-123:
const mapping = getMapping('project', 'abc-123');

if (!mapping) {
  console.error('Mapping not generated! Check:');
  console.log('1. API response has `id` field?');
  console.log('2. API response has UUID fields (*_id, *_ids)?');
  console.log('3. Interceptor registered?');
} else {
  console.log('✅ Mapping found:', mapping);
}
```

---

## Migration Guide

### Before (Manual Generation)

```typescript
import { generateLabelToUuidMapping } from '@/lib/labelToUuidFieldMapper';

const MyComponent = ({ data }) => {
  // Manual generation every render
  const mapping = generateLabelToUuidMapping(data);

  const managerUuidField = mapping.manager?.uuidField;
  // ...
};
```

### After (Auto-Generation)

```typescript
import { useLabelToUuidMappingContext } from '@/contexts/LabelToUuidMappingContext';

const MyComponent = ({ entityType, entityId }) => {
  // Instant lookup from cache
  const { getMapping } = useLabelToUuidMappingContext();
  const mapping = getMapping(entityType, entityId);

  const managerUuidField = mapping?.manager?.uuidField;
  // ...
};
```

---

## Testing

### Manual Test

1. **Start app**: `npm run dev`
2. **Login**: Use test credentials
3. **Navigate to project list**: `/project`
4. **Open console**: Check for auto-generated mappings
5. **Verify**: `useLabelToUuidMappingContext().getAllMappings()`

### Expected Output

```typescript
// After loading project list:
{
  "project:abc-123": {
    "manager": { uuidField: "manager__employee_id", ... },
    "sponsor": { uuidField: "sponsor__employee_id", ... }
  },
  "project:def-456": {
    "manager": { uuidField: "manager__employee_id", ... }
  },
  // ... more projects
}
```

---

## Summary

**Auto Label→UUID Mapping Generation**:

1. ✅ **Zero Configuration**: Works automatically on all API responses
2. ✅ **Global Cache**: Single source of truth for all mappings
3. ✅ **Instant Access**: O(1) lookup via context
4. ✅ **Performance**: No recalculation, cached once per entity
5. ✅ **Error Safe**: API responses continue working even if mapping fails
6. ✅ **Developer Friendly**: Simple hook interface

**Result**: Know which UUID field to update when user changes dropdown, with zero manual work!

---

## Related Documentation

- `LABEL_TO_UUID_MAPPING_USAGE.md` - Usage guide for mapping utilities
- `UUID_MAPPING_CACHE_SOLUTION.md` - Original cache design
- `EDITABLE_ENTITY_REFERENCES_SOLUTION_PLAN.md` - Editable references plan
- `UI_COMPONENT_ENTITY_DATA_FLOW.md` - Complete data flow documentation
